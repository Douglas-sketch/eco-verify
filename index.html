<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Eco-Verify ‚Äî FONE DePIN </title>
  <link rel="shortcut icon" href="image.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --accent:#06f30a;
      --accent-2:#00e676;
      --glass-border:rgba(255,255,255,.08);
      --bg:linear-gradient(180deg,#05010a,#071022);
      --card-bg:rgba(12,12,20,.5);
      --muted:#9aa6bf;
      --surface:#0b1220;
      --input-bg:#071219;
      --input-text:#e6eef8;
      --code-bg:#0b1220;
      --body-text:#e6eef8;
      color-scheme:dark;
    }
    :root[data-theme="light"]{
      --accent:#06c755;
      --accent-2:#00e676;
      --glass-border:rgba(2,6,23,.06);
      --bg:#ffffff;
      --card-bg:#ffffff;
      --muted:#475569;
      --surface:#f3f4f6;
      --input-bg:#ffffff;
      --input-text:#020617;
      --code-bg:#f3f4f6;
      --body-text:#020617;
      color-scheme:light;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--body-text);
      font-family:Inter,system-ui,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      scroll-behavior:smooth;
    }
    .glass{
      background:var(--card-bg);
      border:1px solid var(--glass-border);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-radius:12px;
      transition:transform .18s ease,box-shadow .18s ease,border-color .25s ease;
    }
    .glass:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 24px rgba(0,0,0,.16);
    }
    .btn-accent{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#021124;
      padding:.6rem .9rem;
      border-radius:.65rem;
      font-weight:800;
      border:none;
      box-shadow:0 8px 20px rgba(0,230,118,.18);
    }
    .btn-muted{
      background:rgba(255,255,255,.08);
      color:#cbd5e1;
      padding:.5rem .9rem;
      border-radius:.65rem;
      border:1px solid rgba(255,255,255,.12);
    }
    .btn-ghost{
      background:transparent;
      border:1px dashed rgba(255,255,255,.18);
      padding:.45rem .85rem;
      border-radius:.65rem;
      color:var(--muted);
    }
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .small-muted{
      font-size:.9rem;
      color:var(--muted);
    }
    .thumb{
      width:100%;
      max-height:260px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
    }
    .nav-link{
      display:flex;
      align-items:center;
      gap:10px;
      padding:11px;
      border-radius:10px;
      color:var(--muted);
      cursor:pointer;
    }
    .nav-link.active{
      background:rgba(6,199,85,.12);
      color:var(--accent);
      font-weight:700;
    }
    @media (max-width:900px){
      #sidebar{
        position:fixed;
        left:0;
        top:0;
        height:100vh;
        z-index:70;
        transform:translateX(-110%);
        transition:transform .22s ease;
        width:82%;
        max-width:360px;
        padding:16px;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
      }
      #sidebar.open{transform:translateX(0);}
      main{padding:12px;margin-left:0;}
    }
    @media (min-width:901px){
      #sidebar{
        position:fixed;
        left:0;
        top:0;
        width:300px;
        padding:24px;
        height:100vh;
        overflow-y:auto;
      }
      main{margin-left:340px;padding:22px;}
    }
    #sidebarBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:60;
      display:none;
    }
    .modal{
      position:fixed;
      inset:0;
      z-index:95;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.7);
      padding:16px;
    }
    .modal.show{display:flex;}
    pre{
      white-space:pre-wrap;
      word-break:break-word;
      background:var(--code-bg);
      padding:12px;
      border-radius:8px;
      border:1px solid #1f2937;
    }
    .app-input{
      background:var(--input-bg);
      color:var(--input-text);
      border-radius:0.5rem;
    }
    .app-input::placeholder{
      color:rgba(148,163,184,.8);
    }
    .app-surface{
      background:var(--surface);
      color:var(--input-text);
    }
    html, body, #app, .glass {
      transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
    }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen" data-theme="dark">
    <aside id="sidebar" class="glass md:block">
      <div class="flex items-center gap-3 mb-6">
        <img src="image.png" alt="ecoverify-logo" width="50px" height="50px" style="border-radius:12px;"/>
        <div><div class="font-bold">Eco-Verify</div><div class="small-muted">FONE ‚Ä¢ DePIN</div></div>
      </div>
      <nav class="flex flex-col gap-2 mb-6">
        <div class="nav-link active" data-route="dashboard"><i data-lucide="home" class="w-4 h-4"></i> Dashboard</div>
        <div class="nav-link" data-route="missions"><i data-lucide="map-pin" class="w-4 h-4"></i> Missions</div>
        <div class="nav-link" data-route="leaderboard"><i data-lucide="award" class="w-4 h-4"></i> Leaderboard</div>
        <div class="nav-link" data-route="aposta"><i data-lucide="coins" class="w-4 h-4"></i> Bet</div>
        <div class="nav-link" data-route="send"><i data-lucide="send" class="w-4 h-4"></i> Take out/Send</div>
        <div class="nav-link" data-route="receive"><i data-lucide="qr-code" class="w-4 h-4"></i> To receive</div>
        <div class="nav-link" data-route="history"><i data-lucide="clock" class="w-4 h-4"></i> History</div>
        <div class="nav-link" data-route="settings"><i data-lucide="settings" class="w-4 h-4"></i> Settings</div>
      </nav>
      <div class="mt-auto text-xs small-muted space-y-2 pb-[env(safe-area-inset-bottom)]">
        <div>Wallet: <div id="sidebarAddr" class="mono text-sm break-all">‚Äî</div></div>
        <div>Reputation: <div id="sidebarRep" class="mono text-sm">0</div></div>
        <div class="mt-3"><button id="logoutBtn" class="btn-muted w-full">Logout</button></div>
      </div>
    </aside>

    <div id="sidebarBackdrop" class="md:hidden"></div>

    <header class="md:hidden p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="image.png" alt="ecoverify-logo" width="150px" height="150px" style="border-radius:12px;"/>
        <div class="font-bold">Eco-Verify</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="mobileMenuBtn" class="btn-muted px-3 py-1">Menu</button>
        <button id="mobileLoginBtn" class="btn-accent px-3 py-1">Import</button>
      </div>
    </header>

    <main>
      <div class="flex flex-col md:flex-row justify-between items-stretch md:items-start gap-4 mb-6 p-3 md:p-0">
        <div>
          <h1 id="pageTitle" class="font-bold text-xl">Dashboard</h1>
          <p class="text-sm small-muted" id="pageSub">Connect real-world actions ‚Üí earn FONE</p>
        </div>
        <div class="flex items-stretch md:items-center gap-3 w-full md:w-auto">
          <div class="glass p-3 rounded text-right w-full md:w-[340px]">
            <div class="text-xs small-muted">Total balance</div>
            <div id="topBalance" class="text-2xl font-bold mono">0.00 FONE</div>
            <div id="topBreakdown" class="text-xs small-muted mt-1">Available: 0.00 FONE</div>
            <div class="text-xs small-muted mt-2">Address</div>
            <div id="topAddr" class="mono text-sm break-words">‚Äî</div>
          </div>
          <div class="flex gap-2">
            <button id="themeToggle" class="btn-ghost px-3 py-2">Theme</button>
            <button id="openLoginBtn" class="btn-accent px-3 py-2">Connect</button>
          </div>
        </div>
      </div>

      <section id="pages" class="p-3 md:p-0">
        <div id="page-dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
          <div class="lg:col-span-2 space-y-4">
            <div class="glass p-5 md:p-6">
              <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div>
                  <h2 class="font-bold">Wallet</h2>
                  <div class="text-sm small-muted">Manage your wallet and history</div>
                  <div class="mt-3">
                    <div class="mono break-all" id="walletAddressDisplay">‚Äî</div>
                    <div class="mt-2 text-xs small-muted">Status: <span id="uiMode">online</span></div>
                  </div>
                </div>
                <div class="text-right">
                  <button id="openWalletHistory" class="btn-accent">History</button>
                  <div class="mt-2"><button id="btnSyncAll" class="btn-muted text-sm w-full md:w-auto">Sync Balance</button></div>
                  <div class="text-xs small-muted mt-2">Reputation: <strong id="repScore">0</strong></div>
                </div>
              </div>
            </div>

            <div class="glass p-5 md:p-6">
              <div class="flex items-center justify-between">
                <h3 class="font-bold">Nearby missions</h3>
                <div class="text-sm text-teal-300 cursor-pointer" data-route="missions">See all</div>
              </div>
              <div id="miniMissions" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>

            <div class="glass p-5 md:p-6">
              <h3 class="font-bold">How it works?</h3>
              <ol class="text-sm small-muted list-decimal list-inside mt-2 space-y-2">
                <li>Create or import your FONE wallet (save the private key).</li>
                <li>Validate missions and accumulate Credits and Reputation.</li>
                <li>Convert Credits into on-chain balance and send/receive FONE</li>
              </ol>
            </div>
          </div>

          <aside class="space-y-4">
            <div class="glass p-4">
              <h4 class="font-bold">Quick actions</h4>
              <div class="mt-3 grid gap-3">
                <button data-route="missions" class="btn-accent w-full">Complete mission</button>
                <button data-route="leaderboard" class="btn-muted w-full">See Ranking</button>
                <button data-route="send" class="btn-muted w-full">Take out/Send</button>
                <button data-route="receive" class="btn-muted w-full">Receive (QR)</button>
              </div>
            </div>

            <div class="glass p-4">
              <h4 class="font-bold">Missions (fast)</h4>
              <ul id="sideMissionList" class="mt-3 text-sm small-muted space-y-2"></ul>
            </div>
          </aside>
        </div>

        <div id="page-missions" class="hidden">
          <div class="glass p-5 md:p-6">
            <h2 class="font-bold">Missions</h2>
            <p class="text-sm small-muted">Click Complete to send photo + report.</p>
            <div id="missionsList" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </div>
        </div>

        <div id="page-upload" class="hidden">
          <div class="glass p-5 md:p-6 max-w-3xl">
            <h2 class="font-bold">Complete mission</h2>
            <div class="text-sm small-muted mt-1" id="uploadMissionTitle">Mission</div>
            <label class="block mt-4">Photo (attach):
              <input id="fileInput" accept="image/*" type="file" class="mt-2 w-full" />
            </label>
            <div id="previewWrap" class="mt-4 hidden"><img id="previewImg" class="thumb" src="" alt="preview" /></div>
            <label class="block mt-4">Report:
              <textarea id="reportText" rows="5" class="w-full mt-2 p-3 rounded app-input"></textarea>
            </label>
            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <button id="btnSubmitProof" class="btn-accent">Send proof and complete mission</button>
              <button id="btnCancelUpload" class="btn-muted">Cancel</button>
            </div>
            <div id="missionNotice" class="hidden mt-4 glass p-4">
              <div class="font-semibold mb-1">Mission approved ‚úÖ</div>
              <div id="missionDetails" class="text-sm small-muted"></div>
            </div>
          </div>
        </div>

        <div id="page-aposta" class="hidden">
          <div class="glass p-5 md:p-6 max-w-5xl">
            <h2 class="font-bold">Aposta</h2>
            <p class="text-sm small-muted">
              Bet up to 100 FONE analyzing cases from other users. If you follow the majority, you receive your bet + 75%.
            </p>
            <div class="mt-3 text-sm small-muted">
              Your balance: <strong class="mono" id="apostaCredits">0.00</strong> FONE
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="apostaList"></div>
            <div class="mt-4 small-muted">
              Note: Bets use your FONE balance.
            </div>
          </div>
        </div>

        <div id="page-send" class="hidden">
          <div class="glass p-5 md:p-6 max-w-2xl">
            <h2 class="font-bold">Take out / Send FONE</h2>
            <div class="mt-2 text-sm small-muted">
              <div>Available balance: <strong id="sendAvail" class="mono">0.00</strong> FONE</div>
              <div class="mt-1" id="feeInfo">Network fee: ‚Äî</div>
            </div>

            <label class="block mt-4">Destination address
  <div class="flex gap-2 mt-2">
    <input id="inputDest" list="contactsData" class="flex-1 p-3 rounded app-input mono" placeholder="FONE address (f..., 0x..., ...)" />
    <button id="btnScanQR" type="button" class="btn-muted">Scan QR</button>
    <button id="btnSaveContact" type="button" class="btn-ghost">Save</button>
  </div>
  <datalist id="contactsData"></datalist>
  <div id="helpDest" class="mt-1 text-xs small-muted">Scan a QR or choose from your contacts.</div>
</label>

<!-- Modal do scanner -->
<div id="scanModal" class="modal">
  <div class="glass p-4 w-full max-w-md rounded-lg">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-bold">Scan QR</h3>
      <button id="qrClose" class="btn-muted">Fechar</button>
    </div>
    <div id="qr-reader" style="width:100%;"></div>
    <div class="small-muted mt-2">Permita o acesso √† c√¢mera.</div>
  </div>
</div>
            <label class="block mt-3">Value (FONE)
              <div class="flex items-center gap-2 mt-2">
                <input id="inputAmt" type="number" step="0.01" inputmode="decimal" pattern="[0-9]*" class="flex-1 p-3 rounded app-input mono" />
                <button id="btnMax" class="btn-ghost px-3 py-2">MAX</button>
              </div>
              <div class="mt-1 text-xs small-muted">Voc√™ pode enviar at√© o saldo dispon√≠vel.</div>
            </label>

            <label class="block mt-3">Message (optional)
              <input id="inputMsg" maxlength="100" class="w-full mt-2 p-3 rounded app-input" />
              <div class="mt-1 text-xs small-muted">This field is optional and limited to 100 characters.</div>
            </label>

            <div id="sendPreview" class="mt-4 hidden p-3 rounded app-surface text-sm"></div>
            <div id="sendErrors" class="mt-3 text-sm text-red-300"></div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <button id="btnSendTx" class="btn-accent" disabled>Send (sign) ‚Äî use your private key</button>
              <button id="btnSyncBal" class="btn-muted">Sync Balance</button>
            </div>
            <pre id="sendResult" class="mt-4 text-sm mono small-muted"></pre>
          </div>
        </div>

        <div id="page-receive" class="hidden">
          <div class="glass p-5 md:p-6 max-w-2xl">
            <h2 class="font-bold">To receive FONE</h2>
            <p class="text-sm small-muted mt-1">Share your address or QR to receive FONE.</p>
            <div class="mt-4">
              <div class="text-xs small-muted">Your address</div>
              <div id="receiveAddr" class="mono mt-1 break-all">‚Äî</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btnCopyAddr" class="btn-accent">Copy address</button>
                <button id="btnShareAddr" class="btn-muted">To share</button>
                <button id="btnDownloadQR" class="btn-muted">Download QR</button>
              </div>
            </div>

            <div class="mt-5">
              <div class="text-xs small-muted mb-2">QR Code</div>
              <div id="qrWrap" class="inline-block p-3 rounded bg-white">
                <div id="qrCode"></div>
              </div>
            </div>

            <div class="mt-5 text-sm small-muted">
              Send only FONE to this address. Deposits from other networks/tokens may be lost.
            </div>
          </div>
        </div>

        <div id="page-leaderboard" class="hidden">
          <div class="glass p-5 md:p-6 max-w-3xl">
            <h2 class="font-bold">Leaderboard ‚Äî Reputation</h2>
            <p class="text-sm small-muted">Ranking by reputation points (highest first).</p>
            <div id="leaderboardList" class="mt-4"></div>
          </div>
        </div>

        <div id="page-history" class="hidden">
          <div class="glass p-5 md:p-6">
            <h2 class="font-bold">History</h2>
            <div id="historyList" class="mt-4 space-y-2 small-muted"></div>
          </div>
        </div>

        <div id="page-settings" class="hidden">
          <div class="glass p-5 md:p-6 max-w-2xl">
            <h2 class="font-bold">Settings</h2>
            <div class="mt-4 grid md:grid-cols-2 gap-4">
              <div>
                <label class="block">Language
                  <select id="selLang" class="mt-2 p-2 rounded app-input">
                    <option value="en">English (US)</option>
                    <option value="pt">Portuguese (pt-BR)</option>
                  </select>
                </label>
                <label class="block mt-4">Theme
                  <select id="selTheme" class="mt-2 p-2 rounded app-input">
                    <option value="dark">Dark</option>
                    <option value="light">Clear</option>
                  </select>
                </label>
                <label class="block mt-4">Privacy Policy
                  <textarea rows="4" readonly class="w-full mt-2 p-2 rounded app-input text-sm small-muted">Private keys are NEVER saved. You are only asked to sign transactions in this browser.</textarea>
                </label>
              </div>
              <div>
                <h3 class="font-bold">Fone API</h3>
                <label class="block mt-2">SDK Key
                  <input id="cfgSdk" class="mt-2 p-2 rounded app-input mono w-full" type="password" placeholder="cole sua SDK key (apenas teste)" />
                </label>
                <label class="block mt-2">Base URL
                  <input id="cfgBase" class="mt-2 p-2 rounded app-input mono w-full" value="https://fonenetwork.ddns.net:8543" />
                </label>
                <div class="mt-3 flex gap-2">
                  <button id="btnSaveCfg" class="btn-accent">Save</button>
                  <button id="btnTestCfg" class="btn-muted">Test connection</button>
                </div>
                <div id="cfgMsg" class="small-muted mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="toast" style="position:fixed;right:12px;bottom:12px;z-index:90;display:flex;flex-direction:column;gap:8px;max-width:90vw;"></div>

    <div id="loginModal" class="modal">
      <div class="glass p-6 w-full max-w-2xl rounded-lg">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-xl">Create or Import Wallet</h2>
          <div class="text-sm small-muted">Private key is sensitive ‚Äî don't share.</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-bold">Create new wallet</h3>
            <p class="text-sm small-muted">Generates address and private key (displays once).</p>
            <div class="mt-3 flex gap-3"><button id="btnCreateWallet" class="btn-accent w-full">Create Wallet</button></div>
            <div id="createdResult" class="mt-3 text-sm mono small-muted"></div>
          </div>
          <div>
            <h3 class="font-bold">Import wallet</h3>
            <p class="text-sm small-muted">Paste your private key.</p>
            <input id="inputPrivate" class="mt-2 p-3 rounded app-input mono w-full" type="password" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="Private key..." />
            <div class="mt-3 flex gap-3"><button id="btnImportWallet" class="btn-muted w-full">Import</button></div>
            <div id="importResult" class="mt-3 text-sm mono small-muted"></div>
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button id="closeLogin" class="btn-muted">Close</button>
        </div>
      </div>
    </div>

    <div id="privModal" class="modal">
      <div class="glass p-6 w-full max-w-lg rounded-lg">
        <h3 class="font-bold text-lg">‚ö†Ô∏è Save your private key</h3>
        <p class="mt-2 text-sm small-muted">This is the only time the private key will be displayed.</p>
        <pre id="privText" class="mono mt-3 p-3 rounded text-sm small-muted"></pre>
        <div class="mt-4 flex gap-3">
          <button id="btnCopyPriv" class="btn-accent">Copy</button>
          <button id="btnPrivSaved" class="btn-muted">I already saved ‚Äî continue</button>
        </div>
      </div>
    </div>

    <div id="welcomeModal" class="modal">
      <div class="glass p-6 w-full max-w-lg rounded-lg text-center">
        <h3 class="font-bold text-xl mb-2">Welcome to Eco-Verify</h3>
        <p class="text-sm small-muted">Connect real-world stocks and send/receive FONE to your wallet.</p>
        <div class="mt-5 flex gap-3 justify-center">
          <button id="btnStart" class="btn-accent">To start</button>
        </div>
      </div>
    </div>

    <!-- Gate: criar/desbloquear senha do app -->
    <div id="gate" class="modal">
      <div class="glass p-6 w-full max-w-sm rounded-lg">
        <h3 class="font-bold text-lg mb-2">App password</h3>

        <div id="gateCreateView">
          <p class="small-muted">Create a password to lock/unlock your wallet on this device.</p>
          <label class="block mt-3">Password
            <input id="newPass" type="password" class="mt-2 p-3 rounded app-input w-full" autocomplete="new-password">
          </label>
          <label class="block mt-3">Confirm password
            <input id="newPass2" type="password" class="mt-2 p-3 rounded app-input w-full" autocomplete="new-password">
          </label>
          <div class="mt-4 flex gap-2">
            <button id="gateCreateBtn" class="btn-accent w-full">Create password</button>
          </div>
          <div id="gateMsg" class="small-muted mt-2"></div>
        </div>

        <div id="gateUnlockView" class="hidden">
          <p class="small-muted">Enter your password to continue.</p>
          <input id="gatePass" type="password" class="mt-3 p-3 rounded app-input w-full" autocomplete="current-password">
          <div class="mt-4 flex gap-2">
            <button id="gateBtn" class="btn-accent w-full">Unlock</button>
          </div>
          <div id="gateMsg2" class="small-muted mt-2"></div>
        </div>
      </div>
    </div>

    <!-- Auth: confirmar a√ß√µes cr√≠ticas (enviar/logout) -->
    <div id="authModal" class="modal">
      <div class="glass p-6 w-full max-w-sm rounded-lg">
        <h3 id="authTitle" class="font-bold text-lg mb-2">Confirm action</h3>
        <p id="authHint" class="small-muted">Enter your password to continue.</p>
        <input id="authPass" type="password" class="mt-3 p-3 rounded app-input w-full" autocomplete="current-password">
        <div class="mt-4 flex gap-2">
          <button id="authCancel" class="btn-muted w-1/2">Cancel</button>
          <button id="authOk" class="btn-accent w-1/2">Confirm</button>
        </div>
        <div id="authMsg" class="small-muted mt-2"></div>
      </div>
    </div>
  </div>

  <script>
    const LS_LAST_WALLET = 'ev_last_wallet';
    const LS_WALLET_PREFIX = 'ev_wallet_';
    const LS_THEME = 'ev_theme';
    const LS_WELCOME = 'ev_welcome_seen';
    const LS_SDK = 'ev_sdk';
    const LS_BASE = 'ev_base';
    const PASS_HASH = 'ev_pass_hash'; // n√£o usado mais (mantido por compat)
    const GATE_FLAG = 'ev_gate_ok';
    const USE_PROXY = false;

    // App Password (armazenamento de verificador)
    const PASS_SALT = 'ev_pass_salt';
    const PASS_VER = 'ev_pass_ver';
    const PASS_ITER = 'ev_pass_iter';

    // Config: pedir senha para enviar e para sair
    const REQUIRE_PWD_FOR_SEND = true;
    const REQUIRE_PWD_FOR_LOGOUT = true;

    // Helpers senha
    const enc = new TextEncoder();
    const toHex = (u8) => Array.from(u8).map(b => b.toString(16).padStart(2,'0')).join('');
    const fromHex = (hex) => new Uint8Array((hex.match(/.{2}/g)||[]).map(h => parseInt(h,16)));

    async function deriveHex(pass, saltHex, iter) {
      const keyMat = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: fromHex(saltHex), iterations: iter, hash: 'SHA-256' },
        keyMat, 256
      );
      return toHex(new Uint8Array(bits));
    }
    async function setAppPassword(pass) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const saltHex = toHex(salt);
      const iter = 150000;
      const ver = await deriveHex(pass, saltHex, iter);
      localStorage.setItem(PASS_SALT, saltHex);
      localStorage.setItem(PASS_ITER, String(iter));
      localStorage.setItem(PASS_VER, ver);
    }
    async function verifyAppPassword(pass) {
      const saltHex = localStorage.getItem(PASS_SALT);
      const iter = parseInt(localStorage.getItem(PASS_ITER) || '150000', 10);
      const ver = localStorage.getItem(PASS_VER);
      if (!saltHex || !ver) return false;
      const check = await deriveHex(pass, saltHex, iter);
      return check === ver;
    }
    function isPasswordSet() {
      return !!localStorage.getItem(PASS_VER);
    }
    function isUnlocked() {
      return sessionStorage.getItem(GATE_FLAG) === '1';
    }
    function setUnlocked(flag) {
      if (flag) sessionStorage.setItem(GATE_FLAG, '1');
      else sessionStorage.removeItem(GATE_FLAG);
    }
    function showGate(show) {
      const el = $('gate');
      if (el) el.classList.toggle('show', !!show);
    }
    function showAuthModal(show) {
      $('authModal')?.classList.toggle('show', !!show);
      if (show) {
        const i = $('authPass');
        if (i) { i.value=''; i.focus(); }
        const m = $('authMsg'); if (m) m.textContent='';
      }
    }
    function requireActionPassword({ title = 'Confirmar a√ß√£o', hint = 'Digite sua senha para continuar.' } = {}) {
      return new Promise((resolve) => {
        $('authTitle').textContent = title;
        $('authHint').textContent = hint;
        showAuthModal(true);

        const onOk = async () => {
          const pass = ($('authPass')?.value || '').trim();
          if (!pass) { $('authMsg').textContent = 'Informe a senha.'; return; }
          if (await verifyAppPassword(pass)) {
            showAuthModal(false); resolve(true);
          } else {
            $('authMsg').textContent = 'Senha incorreta.'; $('authPass')?.select();
          }
        };
        const onCancel = () => { showAuthModal(false); resolve(false); };

        $('authOk').onclick = onOk;
        $('authCancel').onclick = onCancel;
        $('authPass').onkeydown = (e) => { if (e.key === 'Enter') onOk(); if (e.key === 'Escape') onCancel(); };
      });
    }
    function bindGateUI() {
      const hasPwd = isPasswordSet();
      const createView = $('gateCreateView');
      const unlockView = $('gateUnlockView');
      if (createView) createView.classList.toggle('hidden', hasPwd);
      if (unlockView) unlockView.classList.toggle('hidden', !hasPwd);

      $('gateCreateBtn')?.addEventListener('click', async () => {
        const p1 = ($('newPass')?.value || '').trim();
        const p2 = ($('newPass2')?.value || '').trim();
        const msg = $('gateMsg');
        if (p1.length < 6) { msg.textContent = 'Use pelo menos 6 caracteres.'; return; }
        if (p1 !== p2) { msg.textContent = 'As senhas n√£o conferem.'; return; }
        await setAppPassword(p1);
        setUnlocked(true);
        showGate(false);
        ensureSdkConfigured();
        toast('Senha criada. App desbloqueado.', 1800);
      });

      $('gateBtn')?.addEventListener('click', async () => {
        const pass = ($('gatePass')?.value || '').trim();
        const msg = $('gateMsg2');
        if (!pass) { msg.textContent = 'Informe a senha.'; return; }
        if (await verifyAppPassword(pass)) {
          setUnlocked(true);
          showGate(false);
          ensureSdkConfigured();
          toast('Desbloqueado üëå', 1500);
        } else {
          msg.textContent = 'Senha incorreta.'; $('gatePass')?.select();
        }
      });

      $('gatePass')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') $('gateBtn')?.click(); });
      $('newPass2')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') $('gateCreateBtn')?.click(); });
    }
    function initPasswordLock() {
      if (!isPasswordSet()) {
        showGate(true);
        bindGateUI();
        return;
      }

      if (isUnlocked()) {
        showGate(false);
        ensureSdkConfigured();
        return;
      }

      showGate(true);
      bindGateUI();
    }
    function lockApp() {
      setUnlocked(false);
      showGate(true);
    }

    const State = {
      settings: {
        baseUrl: localStorage.getItem(LS_BASE) || 'https://fonenetwork.ddns.net:8543',
        sdkKey: localStorage.getItem(LS_SDK) || ''
      },
      wallet: null,
      persistedWalletAddress: localStorage.getItem(LS_LAST_WALLET) || null,
      balance: {
        onchain: {
          available: 0,
          staked: 0,
          vested: 0,
          total: 0
        },
        credits: 0,         // mantido, mas n√£o √© mais usado pra convers√£o
        totalUI: 0,
        disponivelUI: 0
      },
      history: [],
      missions: [],
      completedMissionIds: [],
      leaderboard: {},
      reputation: 0,
      reviewQueue: [],
      bets: {},
      syncing: false
    };
    const $ = (id) => document.getElementById(id);

    function applyTheme(theme) {
      const t = theme === 'light' ? 'light' : 'dark';
      const root = document.documentElement;
      root.setAttribute('data-theme', t);
      const app = $('app');
      if (app) app.setAttribute('data-theme', t);
    }

    function toast(msg, time = 3200, type = 'info') {
      const colors = {
        success: 'border-emerald-500 text-emerald-200',
        error: 'border-rose-500 text-rose-200',
        warning: 'border-amber-500 text-amber-200',
        info: 'border-sky-500 text-sky-200'
      };
      const el = document.createElement('div');
      el.className = `glass p-3 border ${colors[type] || colors.info}`;
      el.style.minWidth = '220px';
      el.innerHTML = `<div class="font-medium">${msg}</div>`;
      $('toast')?.appendChild(el);
      setTimeout(() => el.remove(), time);
    }

    function showModal(id, show = true) {
      const el = $(id);
      if (!el) return;
      if (show) el.classList.add('show');
      else el.classList.remove('show');
    }

    function savePersistentForAddress(addr) {
      if (!addr) return;
      const payload = {
        address: addr,
        balance: State.balance,
        history: State.history,
        missions: State.missions,
        completedMissionIds: State.completedMissionIds,
        leaderboard: State.leaderboard,
        reputation: State.reputation,
        reviewQueue: State.reviewQueue,
        bets: State.bets
      };
      try {
        localStorage.setItem(LS_WALLET_PREFIX + addr, JSON.stringify(payload));
        localStorage.setItem(LS_LAST_WALLET, addr);
      } catch {}
    }

    function loadPersistentForAddress(addr) {
      try {
        const raw = localStorage.getItem(LS_WALLET_PREFIX + addr);
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    function recalcTotals() {
      State.balance.totalUI = Number(State.balance.onchain.total || 0) + Number(State.balance.credits || 0);
      State.balance.disponivelUI = Number(State.balance.onchain.available || 0) + Number(State.balance.credits || 0);
    }

    function updateUI() {
      const total = Number(State.balance.onchain.total || 0);
      $('topBalance').innerText = `${total.toFixed(2)} FONE`;
      $('topBreakdown').innerText = `Available: ${Number(State.balance.onchain.available || 0).toFixed(2)} FONE`;
      const addr = getActiveAddress() || '‚Äî';
      $('topAddr').innerText = addr;
      $('walletAddressDisplay').innerText = addr;
      $('sidebarAddr').innerText = addr;
      $('sidebarRep').innerText = State.reputation || 0;
      $('repScore').innerText = State.reputation || 0;
      $('sendAvail').innerText = Number(State.balance.onchain.available || 0).toFixed(2);

      const hasWallet = !!getActiveAddress();
      if ($('logoutBtn')) $('logoutBtn').style.display = hasWallet ? 'block' : 'none';
      if ($('openLoginBtn')) $('openLoginBtn').style.display = hasWallet ? 'none' : 'inline-flex';
      if ($('mobileLoginBtn')) $('mobileLoginBtn').style.display = hasWallet ? 'none' : 'inline-flex';

      renderMiniMissions();
      renderMissionsPage();
      renderLeaderboard();
      renderHistory();
      renderApostaPage();
      if ($('page-receive') && !$('page-receive').classList.contains('hidden')) renderReceivePage();
      applySendValidationUI();
      savePersistentForAddress(getActiveAddress());
      try {
        lucide.createIcons();
      } catch {}
    }

    function showPage(name) {
      document.querySelectorAll('[id^="page-"]').forEach(s => s.classList.add('hidden'));
      const page = $('page-' + name);
      if (page) page.classList.remove('hidden');
      document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
      const nav = Array.from(document.querySelectorAll('.nav-link')).find(n => n.dataset && n.dataset.route === name);
      if (nav) nav.classList.add('active');
      const map = {
        dashboard: 'Dashboard',
        missions: 'Miss√µes',
        send: 'Sacar/Enviar',
        receive: 'Receber',
        history: 'Hist√≥rico',
        settings: 'Configura√ß√µes',
        upload: 'Enviar Prova',
        leaderboard: 'Leaderboard',
        aposta: 'Aposta'
      };
      $('pageTitle').innerText = map[name] || 'Eco-Verify';
    }

    function getActiveAddress() {
      return State.wallet?.address || State.persistedWalletAddress || null;
    }

    function normBase(u) {
      return (u || '').replace(/\/+$/, '');
    }
    async function api(path, method = 'GET', body) {
      if (!USE_PROXY) {
        const base = State.settings.baseUrl || localStorage.getItem(LS_BASE) || 'https://fonenetwork.ddns.net:8543';
        const sdk = State.settings.sdkKey || localStorage.getItem(LS_SDK) || '';
        if (!sdk) throw new Error('SDK key n√£o configurada ‚Äî abra Configura√ß√µes > Fone API');
        const url = normBase(base) + path;
        const headers = {
          'api-key': sdk,
          'Accept': 'application/json'
        };
        if (body) headers['Content-Type'] = 'application/json';
        let res;
        try {
          res = await fetch(url, {
            method,
            headers,
            body: body ? JSON.stringify(body) : undefined
          });
        } catch (e) {
          if (base.includes(':8543')) {
            const alt = base.replace(':8543', '');
            res = await fetch(normBase(alt) + path, {
              method,
              headers,
              body: body ? JSON.stringify(body) : undefined
            });
          } else {
            throw new Error('Falha de rede/CORS. Ajuste a Base URL nas Configura√ß√µes.');
          }
        }
        const txt = await res.text();
        let data;
        try {
          data = txt ? JSON.parse(txt) : {};
        } catch {
          data = { raw: txt || '' };
        }
        if (!res.ok) throw new Error(data?.error || res.statusText || `HTTP ${res.status}`);
        return data;
      } else {
        const mapped = path
          .replace(/^\/v1\/wallet\/create$/, '/api/wallet/create')
          .replace(/^\/v1\/wallet\/import$/, '/api/wallet/import')
          .replace(/^\/v1\/transaction\/send$/, '/api/transaction/send')
          .replace(/^\/v1\/transaction\//, '/api/transaction/')
          .replace(/^\/v1\/wallet\/([^/]+)\/balance$/, '/api/wallet/$1/balance')
          .replace(/^\/v1\/wallet\/([^/]+)\/transactions(.*)$/, '/api/wallet/$1/transactions$2');
        const res = await fetch(mapped, {
          method,
          headers: body ? { 'Content-Type': 'application/json' } : {},
          body: body ? JSON.stringify(body) : undefined
        });
        const txt = await res.text();
        let data;
        try { data = txt ? JSON.parse(txt) : {}; }
        catch { data = { raw: txt || '' }; }
        if (!res.ok) throw new Error(data?.error || res.statusText || `HTTP ${res.status}`);
        return data;
      }
    }
    async function createWalletFlow() {
      try {
        const data = await api('/v1/wallet/create', 'POST');
        const addr = data.address, priv = data.privateKey;
        if (!addr || !priv) throw new Error('Falha ao criar carteira.');
        State.wallet = { address: addr };
        State.persistedWalletAddress = addr;
        localStorage.setItem(LS_LAST_WALLET, addr);
        State.balance.credits = 0;
        recalcTotals();
        $('createdResult').innerText = `Endere√ßo: ${addr}`;
        showModal('privModal', true);
        $('privText').innerText = priv;
        await syncAll();
        updateUI();
        showModal('loginModal', false);
        toast('Carteira criada.', 2200);
      } catch (e) {
        $('createdResult').innerText = 'Erro: ' + e.message;
      }
    }
    async function importWalletFlow(pk) {
      if (!pk || pk.length < 6) {
        $('importResult').innerText = 'Chave inv√°lida';
        return;
      }
      try {
        const data = await api('/v1/wallet/import', 'POST', { privateKey: String(pk).trim() });
        const addr = data.address;
        if (!addr) throw new Error('Resposta sem endere√ßo.');
        const persisted = loadPersistentForAddress(addr);
        if (persisted) {
          State.persistedWalletAddress = addr;
          Object.assign(State, {
            balance: persisted.balance || State.balance,
            history: persisted.history || [],
            missions: persisted.missions || [],
            completedMissionIds: persisted.completedMissionIds || [],
            leaderboard: persisted.leaderboard || {},
            reputation: persisted.reputation || 0,
            reviewQueue: persisted.reviewQueue || [],
            bets: persisted.bets || {}
          });
        } else {
          State.persistedWalletAddress = addr;
          State.balance = {
            onchain: { available: 0, staked: 0, vested: 0, total: 0 },
            credits: 0,
            totalUI: 0,
            disponivelUI: 0
          };
          State.history = [];
          State.completedMissionIds = [];
          State.leaderboard = {};
          State.reputation = 0;
          State.reviewQueue = [];
          State.bets = {};
          buildMissions();
          buildReviewQueueAposta();
          recalcTotals();
        }
        State.wallet = { address: addr };
        localStorage.setItem(LS_LAST_WALLET, addr);
        $('importResult').innerText = `Carteira importada: ${addr}`;
        await syncAll();
        updateUI();
        showModal('loginModal', false);
        toast('Carteira importada.', 2200);
      } catch (e) {
        $('importResult').innerText = 'Erro: ' + e.message;
      }
    }
    async function syncBalance() {
      const addr = getActiveAddress();
      if (!addr) return;
      const b = await api(`/v1/wallet/${encodeURIComponent(addr)}/balance`, 'GET');
      const bal = b?.balance || {};
      State.balance.onchain.available = Number(bal.available || 0);
      State.balance.onchain.total = Number(bal.total || bal.available || 0);
      State.balance.onchain.staked = Number(bal.staked || 0);
      State.balance.onchain.vested = Number(bal.vested || 0);
      recalcTotals();
    }

    function txLine(tx, me) {
      const when = new Date(tx.timestamp).toLocaleString();
      const isOut = (tx.sender || '').toLowerCase() === (me || '').toLowerCase();
      const peer = isOut ? tx.recipient : tx.sender;
      const dir = isOut ? 'Enviado' : 'Recebido';
      const msg = tx.message ? ` (${tx.message})` : '';
      const st = tx.status === 1 ? ' [pendente]' : '';
      return `[${when}] ${dir} ${tx.amount} FONE ${isOut ? '->' : '<-'} ${peer}${msg}${st}`;
    }
    async function syncTransactions() {
      const addr = getActiveAddress();
      if (!addr) return;
      const data = await api(`/v1/wallet/${encodeURIComponent(addr)}/transactions`, 'GET');
      const txs = data?.addressData?.addressTransactions || [];
      const known = new Set(State.history || []);
      txs.forEach(tx => {
        const line = txLine(tx, addr);
        if (!known.has(line)) State.history.push(line);
      });
    }
    async function syncAll() {
      if (!getActiveAddress()) return;
      State.syncing = true;
      updateUI();
      try {
        await syncBalance();
        await syncTransactions();
      } catch (e) {
        toast('Falha ao sincronizar: ' + e.message, 2600);
      }
      State.syncing = false;
      updateUI();
    }

    function isValidFoneAddress(a) {
      if (typeof a !== 'string') return false;
      const s = a.trim();
      return /^[a-zA-Z0-9]{6,120}$/.test(s);
    }

    function validateSendForm() {
      const dest = ($('inputDest')?.value || '').trim();
      const amt = Number($('inputAmt')?.value);
      const onAvail = Number(State.balance?.onchain?.available || 0);
      const errs = [];
      if (!dest) errs.push('Informe o endere√ßo de destino.');
      else if (!isValidFoneAddress(dest)) errs.push('Endere√ßo inv√°lido.');
      if (!amt || !Number.isFinite(amt) || amt <= 0) errs.push('Informe um valor v√°lido.');
      if (Number.isFinite(amt) && amt > 0 && amt > onAvail) {
        errs.push('Saldo insuficiente.');
      }
      if (getActiveAddress() && dest === getActiveAddress()) errs.push('N√£o envie para o pr√≥prio endere√ßo.');
      return { ok: errs.length === 0, dest, amt, errors: errs };
    }

    function applySendValidationUI() {
      const res = validateSendForm();
      const btn = $('btnSendTx');
      const errBox = $('sendErrors');
      const prev = $('sendPreview');
      if (btn) btn.disabled = !res.ok;
      if (errBox) errBox.innerHTML = res.errors.map(e => `<div>‚Ä¢ ${e}</div>`).join('');
      if (prev) {
        if (res.ok) {
          prev.classList.remove('hidden');
          prev.innerHTML = `<div class="small-muted">Resumo</div><div class="mt-1">You will send <strong>${res.amt}</strong> FONE for <span class="mono">${res.dest}</span></div>`;
        } else {
          prev.classList.add('hidden');
          prev.innerHTML = '';
        }
      }
    }
    async function sendTransactionFlow(privateKey, recipient, amount, message) {
      const payload = {
        privateKey,
        recipient,
        amount: Number(amount),
        ...(message ? { message } : {})
      };
      const res = await api('/v1/transaction/send', 'POST', payload);
      return res;
    }

    function buildMissions() {
      if (State.missions && State.missions.length) return;
      State.missions = [
        { id: 'M1', title: 'Check recyclable bins -Parque Jaqueira', difficulty: 'easy', reward: 20, location: 'Recife, PE', description: 'Take a photo of the trash bin with separated materials.' },
        { id: 'M2', title: 'Photograph planted trees -Rua X', difficulty: 'medium', reward: 30, location: 'Recife, PE', description: 'Display the tree with identification or a sign.' },
        { id: 'M3', title: 'Electronic disposal -Official point', difficulty: 'medium', reward: 25, location: 'Olinda, PE', description: 'Photo of the disposal point and ticket.' },
        { id: 'M4', title: 'Water saving record', difficulty: 'easy', reward: 12, location: 'Casa', description: 'Photo of the meter before/after or repaired tap.' },
        { id: 'M5', title: 'Used oil collection delivered', difficulty: 'medium', reward: 18, location: 'Point', description: 'Photo of the container at the collection point with label.' },
        { id: 'M6', title: 'Clothes donation report', difficulty: 'easy', reward: 15, location: 'ONG local', description: 'Photo of the receipt or location of the donation.' },
        { id: 'M7', title: 'Community cleaning', difficulty: 'hard', reward: 22, location: 'Central square', description: 'Show before and after cleaning.' }
      ];
    }

    function repFor(d) {
      return d === 'easy' ? 5 : d === 'medium' ? 10 : d === 'hard' ? 20 : 0;
    }

    function renderMiniMissions() {
      const el = $('miniMissions');
      const side = $('sideMissionList');
      if (!el || !side) return;
      el.innerHTML = '';
      side.innerHTML = '';
      const available = State.missions.filter(m => !State.completedMissionIds.includes(m.id));
      available.slice(0, 4).forEach(m => {
        el.innerHTML += `<div class="p-4 rounded app-surface">
          <div class="font-semibold">${m.title}</div>
          <div class="text-sm small-muted">${m.location} ‚Ä¢ ${m.reward} FONE</div>
          <div class="mt-3"><button class="btn-accent" onclick="openMission('${m.id}')">Complete mission</button></div>
        </div>`;
      });
      State.missions.forEach(m => {
        if (!State.completedMissionIds.includes(m.id)) side.innerHTML += `<li class="flex justify-between"><span>${m.title}</span><span class="text-sm small-muted">${m.reward} F</span></li>`;
      });
    }

    function renderMissionsPage() {
      const list = $('missionsList');
      if (!list) return;
      list.innerHTML = '';
      State.missions.forEach(m => {
        const done = State.completedMissionIds.includes(m.id);
        const prog = done ? 100 : Math.floor(Math.random() * 60);
        const rep = repFor(m.difficulty);
        const card = document.createElement('div');
        card.className = 'glass p-4';
        card.innerHTML = `
          <div class="font-semibold">${m.title}</div>
          <div class="text-sm small-muted mt-1">${m.description}</div>
          <div class="text-xs small-muted mt-2">${m.location} ‚Ä¢ Recompensa: <strong>${m.reward} FONE</strong> ‚Ä¢ <em>${m.difficulty.toUpperCase()}</em></div>
          <div class="mt-3">
            <div class="w-full h-2.5 bg-black/20 rounded overflow-hidden">
              <div class="h-2.5 rounded" style="width:${prog}%; background:linear-gradient(90deg, var(--accent), var(--accent-2))"></div>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <div class="text-sm small-muted">${prog}% completed</div>
              <div class="ml-auto">
                ${done ? '<span class="small-muted">Conclu√≠da ‚úÖ</span>' : `<button class="btn-accent" onclick="openMission('${m.id}')">Complete mission</button>`}
              </div>
            </div>
          </div>
          <div class="mt-3 text-xs small-muted">Reputation Points: ${rep}</div>`;
        list.appendChild(card);
      });
    }
    window.openMission = function openMission(id) {
      const m = State.missions.find(x => x.id === id);
      if (!m) return toast('Miss√£o n√£o encontrada', 2500);
      if (!getActiveAddress()) return toast('Conecte sua carteira primeiro.', 2500);
      $('uploadMissionTitle').innerText = `${m.title} ‚Ä¢ Recompensa: ${m.reward} FONE`;
      sessionStorage.setItem('currentMission', JSON.stringify(m));
      $('fileInput').value = '';
      $('reportText').value = '';
      $('previewWrap').classList.add('hidden');
      $('missionNotice').classList.add('hidden');
      showPage('upload');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    $('fileInput')?.addEventListener('change', (ev) => {
      const f = ev.target.files[0];
      if (!f) return;
      $('previewImg').src = URL.createObjectURL(f);
      $('previewWrap').classList.remove('hidden');
    });
    let missionSubmitting = false;

    function uploadStaging() {
      return new Promise(r => setTimeout(r, 400));
    }
    $('btnCancelUpload')?.addEventListener('click', () => showPage('missions'));
    $('btnSubmitProof')?.addEventListener('click', async () => {
      if (missionSubmitting) return;
      const m = JSON.parse(sessionStorage.getItem('currentMission') || 'null');
      if (!m) return toast('Session expired', 2500);
      const file = $('fileInput').files[0];
      const report = $('reportText').value.trim();
      if (!file) return alert('Selecione uma foto');
      if (!report || report.length < 10) return toast('Write a report with at least 10 characters');
      missionSubmitting = true;
      toast('Validating mission‚Ä¶', 1800);
      try {
        await uploadStaging();
        await new Promise(r => setTimeout(r, 800));
        if (!State.completedMissionIds.includes(m.id)) State.completedMissionIds.push(m.id);
        const repAdd = repFor(m.difficulty);
        State.reputation = Number(State.reputation || 0) + repAdd;
        const me = getActiveAddress() || 'anonymous';
        State.leaderboard[me] = Number(State.leaderboard[me] || 0) + repAdd;

        const reward = Number(m.reward || 0);
        State.balance.onchain.available = Number(State.balance.onchain.available || 0) + reward;
        State.balance.onchain.total = Number(State.balance.onchain.total || 0) + reward;
        recalcTotals();

        $('missionDetails').innerHTML = `
          <div>ID: <span class="mono">${m.id}</span></div>
          <div>Mission: ${m.title}</div>
          <div>Reward credited: <strong>${m.reward} FONE</strong></div>
          <div>Reputation: +${repAdd} pts</div>`;
        $('missionNotice').classList.remove('hidden');
        savePersistentForAddress(getActiveAddress());
        await syncAll();
        updateUI();
        toast('Mission approved! Credits added.', 3000);
        showPage('dashboard');
      } catch (e) {
        toast('Erro: ' + e.message, 3000);
      } finally {
        missionSubmitting = false;
      }
    });

    function randAddr() {
      const h = Array.from(crypto.getRandomValues(new Uint8Array(6))).map(b => b.toString(16).padStart(2, '0')).join('');
      return 'f' + h;
    }

    function buildReviewQueueAposta() {
      if (State.reviewQueue && State.reviewQueue.length) return;
      State.reviewQueue = [
        { id: 'R1', title: 'Community cleaning ‚Äî Central square', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r1/640/360', report: 'Before and after visible. Bags collected and team identified.', reward: 22, isValid: true },
        { id: 'R2', title: 'Electronic disposal ‚Äî Official point', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r2/640/360', report: 'Photo of a generic box, without proof of official point.', reward: 25, isValid: false },
        { id: 'R3', title: 'Trees planted ‚Äî Rua X', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r3/640/360', report: 'Changes with identification and plate, date and location informed.', reward: 30, isValid: true },
        { id: 'R4', title: 'Recycling ‚Äî Park', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r4/640/360', report: 'Blurred image and no visible separation of materials.', reward: 20, isValid: false }
      ];
    }

    function renderApostaPage() {
      const wrap = $('apostaList');
      if (!wrap) return;
      $('apostaCredits').innerText = Number(State.balance.onchain.available || 0).toFixed(2);
      wrap.innerHTML = '';
      if (!State.reviewQueue.length) {
        wrap.innerHTML = '<div class="small-muted">‚Äî No cases to review ‚Äî</div>';
        return;
      }
      State.reviewQueue.forEach(item => {
        const bet = State.bets[item.id];
        const statusLine = (() => {
          if (!bet) return '';
          if (bet.status === 'pending') {
            return `<div class="mt-2 text-xs small-muted"><span class="inline-flex items-center gap-2"> <span class="w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse"></span>Waiting for majority‚Ä¶</span></div>`;
          }
          const maj = bet.majority === 'approve' ? 'APPROVED' : 'FAIL';
          const res = bet.win ? 'You Win üéâ' : 'You Lose';
          const delta = bet.win ? `+${(bet.payout - bet.amount).toFixed(2)} FONE` : `-${bet.amount.toFixed(2)} FONE`;
          return `<div class="mt-2 text-xs"><div>Result: <strong>${maj}</strong></div><div>${res} ‚Ä¢ ${delta}</div></div>`;
        })();
        const disabled = bet && (bet.status === 'pending' || bet.status === 'settled') ? 'disabled' : '';
        const div = document.createElement('div');
        div.className = 'glass p-4 rounded';
        div.innerHTML = `
          <div class="font-semibold">${item.title}</div>
          <div class="text-xs small-muted">Recompensa: ${item.reward} FONE ‚Ä¢ Sent by <span class="mono">${item.submitter}</span></div>
          <div class="mt-3"><img src="${item.image}" alt="proof" class="thumb" /></div>
          <div class="mt-2 small-muted">${item.report}</div>
          <div class="mt-3 text-xs small-muted">Bet up to 100 FONE</div>
          <div class="mt-1 flex items-center gap-2">
            <input id="bet-${item.id}" type="number" min="1" max="100" step="1" class="p-2 rounded app-input mono w-24" ${disabled} value="${Math.min(10, Math.floor((State.balance?.onchain?.available || 0) / 2))}">
            <button class="btn-accent" ${disabled} onclick="placeBet('${item.id}','approve')">Validate</button>
            <button class="btn-muted" ${disabled} onclick="placeBet('${item.id}','reject')">Fail</button>
          </div>
          ${statusLine}`;
        wrap.appendChild(div);
      });
      try {
        lucide.createIcons();
      } catch {}
    }
    window.placeBet = function placeBet(id, decision) {
      const item = State.reviewQueue.find(x => x.id === id);
      if (!item) return toast('Item n√£o encontrado', 2500);
      if (State.bets[id]) return toast('Voc√™ j√° apostou neste item.', 2500);
      const inp = $('bet-' + id);
      const amount = Number(inp?.value || 0);
      if (!Number.isFinite(amount) || amount <= 0) return toast('Informe um valor v√°lido.', 2500);
      if (amount > 100) return toast('Aposta m√°xima √© 100 FONE.', 3000);
      const avail = Number(State.balance?.onchain?.available || 0);
      if (amount > avail) return toast('Saldo insuficiente para apostar.', 3000);
      State.balance.onchain.available = avail - amount;
      State.balance.onchain.total = Math.max(0, Number(State.balance.onchain.total || 0) - amount);
      recalcTotals();
      State.bets[id] = { amount, decision, status: 'pending', createdAt: Date.now() };
      savePersistentForAddress(getActiveAddress());
      updateUI();
      setTimeout(() => settleBet(id), 3000);
    };

    function settleBet(id) {
      const item = State.reviewQueue.find(x => x.id === id);
      const bet = State.bets[id];
      if (!item || !bet || bet.status === 'settled') return;
      const majority = item.isValid ? 'approve' : 'reject';
      const userWin = (bet.decision === majority);
      const payout = userWin ? bet.amount * 1.75 : 0;
      if (payout > 0) {
        State.balance.onchain.available = Number(State.balance.onchain.available || 0) + payout;
        State.balance.onchain.total = Number(State.balance.onchain.total || 0) + payout;
        recalcTotals();
      }
      bet.status = 'settled';
      bet.majority = majority;
      bet.payout = payout;
      bet.win = userWin;
      const votedStr = bet.decision === 'approve' ? 'APPROVE' : 'FAIL';
      const majStr = majority === 'approve' ? 'APPROVED' : 'FAIL';
      const gain = userWin ? `It won +${(payout - bet.amount).toFixed(2)} FONE (return ${payout.toFixed(2)})` : `Lose ${bet.amount.toFixed(2)} FONE`;
      State.history.push(`[${new Date().toLocaleString()}] Bet: ${item.title} ‚Äî vote ${votedStr}. ${gain} ‚Ä¢ majority: ${majStr}`);
      savePersistentForAddress(getActiveAddress());
      renderApostaPage();
      updateUI();
      toast(userWin ? `You won the bet! +${(payout - bet.amount).toFixed(2)} FONE` : `You lose: -${bet.amount.toFixed(2)} FONE`, 3800);
    }

    const LS_CONTACTS = 'ev_contacts';
    function getContacts() {
      try { return JSON.parse(localStorage.getItem(LS_CONTACTS) || '[]'); } catch { return []; }
    }
    function setContacts(list) {
      localStorage.setItem(LS_CONTACTS, JSON.stringify(list));
    }
    function renderContactsDatalist() {
      const data = getContacts();
      const dl = $('contactsData'); if (!dl) return;
      dl.innerHTML = '';
      data.forEach(c => {
        const o = document.createElement('option');
        o.value = c.address;
        o.label = c.label || c.address;
        dl.appendChild(o);
      });
    }
    function saveContact(address, label) {
      if (!address) return;
      const list = getContacts();
      if (!list.find(c => c.address === address)) {
        list.push({ address, label: label || '' });
        setContacts(list);
        renderContactsDatalist();
        toast('Contato salvo.', 1400, 'success');
      } else {
        toast('Contato j√° existe.', 1600, 'info');
      }
    }

    let qrInstance = null;
    function openScan() {
      showModal('scanModal', true);
      const el = $('qr-reader');
      if (!el) return;
      if (qrInstance) return;
      qrInstance = new Html5Qrcode('qr-reader');
      qrInstance.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 220 },
        (decodedText) => {
          $('inputDest').value = decodedText.trim();
          applySendValidationUI();
          closeScan();
          toast('Endere√ßo preenchido pelo QR.', 1600, 'success');
        },
        () => {}
      ).catch(err => {
        toast('Erro ao iniciar c√¢mera: ' + err, 3000, 'error');
      });
    }
    function closeScan() {
      if (qrInstance) {
        qrInstance.stop().then(() => {
          qrInstance.clear(); qrInstance = null;
        }).catch(()=>{});
      }
      showModal('scanModal', false);
    }
    $('btnScanQR')?.addEventListener('click', openScan);
    $('qrClose')?.addEventListener('click', closeScan);

    // salvar contato
    $('btnSaveContact')?.addEventListener('click', () => {
      const addr = ($('inputDest')?.value || '').trim();
      if (!addr) return toast('Informe um endere√ßo para salvar.', 1800, 'warning');
      if (!isValidFoneAddress(addr)) return toast('Endere√ßo inv√°lido.', 1800, 'error');
      const label = prompt('Apelido para este endere√ßo (opcional):') || '';
      saveContact(addr, label.trim());
    });

    // renderizar datalist no init
    renderContactsDatalist();

    function renderHistory() {
      const el = $('historyList');
      if (!el) return;
      el.innerHTML = '';
      if (!State.history?.length) {
        el.innerHTML = '<div class="small-muted">‚Äî No activity ‚Äî</div>';
        return;
      }
      State.history.slice().reverse().forEach(line => {
        const d = document.createElement('div');
        d.className = 'p-3 glass rounded';
        d.innerText = line;
        el.appendChild(d);
      });
    }

    function renderLeaderboard() {
      const el = $('leaderboardList');
      if (!el) return;
      el.innerHTML = '';
      const arr = Object.keys(State.leaderboard).map(a => ({ addr: a, rep: Number(State.leaderboard[a] || 0) }));
      const me = getActiveAddress();
      if (me && !arr.find(x => x.addr === me)) arr.push({ addr: me, rep: State.reputation || 0 });
      arr.sort((a, b) => b.rep - a.rep);
      if (!arr.length) {
        el.innerHTML = '<div class="small-muted">‚Äî no players ‚Äî</div>';
        return;
      }
      arr.forEach((u, idx) => {
        const isMe = me && me === u.addr;
        const row = document.createElement('div');
        row.className = 'p-3 glass rounded flex items-center gap-3';
        row.innerHTML = `<div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021124">${idx + 1}</div> <div style="flex:1"> <div class="font-semibold">${isMe ? 'You' : (u.addr)}</div> <div class="text-xs small-muted">Reputation: <strong>${u.rep}</strong></div> </div> <div class="text-sm small-muted">${u.rep} pts</div>`;
        el.appendChild(row);
      });
    }

    function renderReceivePage() {
      const addr = getActiveAddress() || '‚Äî';
      $('receiveAddr').innerText = addr;
      const qrEl = $('qrCode');
      if (qrEl) {
        qrEl.innerHTML = '';
        if (getActiveAddress()) new QRCode(qrEl, {
          text: addr,
          width: 196,
          height: 196,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }
    }
    document.querySelectorAll('.nav-link').forEach(a => a.addEventListener('click', () => {
      const r = a.dataset.route;
      showPage(r);
      if (window.innerWidth <= 900) {
        $('sidebar')?.classList.remove('open');
        $('sidebarBackdrop').style.display = 'none';
      }
    }));
    document.querySelectorAll('[data-route]')?.forEach(el => el.addEventListener('click', () => {
      const r = el.dataset.route;
      if (r) showPage(r);
    }));
    $('openWalletHistory')?.addEventListener('click', () => showPage('history'));
    $('mobileMenuBtn')?.addEventListener('click', () => {
      $('sidebar')?.classList.add('open');
      $('sidebarBackdrop').style.display = 'block';
    });
    $('sidebarBackdrop')?.addEventListener('click', () => {
      $('sidebar')?.classList.remove('open');
      $('sidebarBackdrop').style.display = 'none';
    });
    $('mobileLoginBtn')?.addEventListener('click', () => showModal('loginModal', true));
    $('openLoginBtn')?.addEventListener('click', () => showModal('loginModal', true));
    $('closeLogin')?.addEventListener('click', () => showModal('loginModal', false));
    $('themeToggle')?.addEventListener('click', () => {
      const cur = localStorage.getItem(LS_THEME) || 'dark';
      const next = cur === 'light' ? 'dark' : 'light';
      applyTheme(next);
      localStorage.setItem(LS_THEME, next);
      updateUI();
    });
    $('selTheme')?.addEventListener('change', (e) => {
      const v = e.target.value;
      applyTheme(v);
      localStorage.setItem(LS_THEME, v);
      updateUI();
    });
    $('btnCreateWallet')?.addEventListener('click', createWalletFlow);
    $('btnImportWallet')?.addEventListener('click', async () => {
      const pk = ($('inputPrivate')?.value || '').trim();
      await importWalletFlow(pk);
    });
    $('btnCopyPriv')?.addEventListener('click', () => {
      const txt = $('privText')?.innerText || '';
      navigator.clipboard.writeText(txt).then(() => toast('Copied Key', 1800));
    });
    $('btnPrivSaved')?.addEventListener('click', () => showModal('privModal', false));
    $('btnSyncAll')?.addEventListener('click', async () => {
      await syncAll();
      toast('Balance/Statement synchronized.', 2000);
    });
    $('btnSyncBal')?.addEventListener('click', async () => {
      await syncAll();
      toast('Balance/Statement synchronized.', 2000);
    });
    $('btnCopyAddr')?.addEventListener('click', () => {
      const addr = getActiveAddress();
      if (!addr) return toast('Wallet not connected', 2000);
      navigator.clipboard.writeText(addr).then(() => toast('Copied address ‚úÖ', 1800));
    });
    $('btnShareAddr')?.addEventListener('click', async () => {
      const addr = getActiveAddress();
      if (!addr) return toast('Wallet not connected', 2000);
      if (navigator.share) {
        try {
          await navigator.share({ title: 'My address FONE', text: addr });
        } catch {}
      } else {
        navigator.clipboard.writeText(addr);
        toast('Copied address (not supported sharing)', 2200);
      }
    });
    $('btnDownloadQR')?.addEventListener('click', () => {
      const wrap = $('qrCode');
      if (!wrap) return;
      const img = wrap.querySelector('img');
      const canvas = wrap.querySelector('canvas');
      const dataUrl = img?.src || (canvas ? canvas.toDataURL('image/png') : null);
      if (!dataUrl) {
        toast('QR unavailable', 2000);
        return;
      }
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = 'fone-address-qr.png';
      a.click();
    });

    document.addEventListener('input', (e) => {
      if (e.target && (e.target.id === 'inputDest' || e.target.id === 'inputAmt')) {
        applySendValidationUI();
      }
    });
    $('btnMax')?.addEventListener('click', () => {
      const onAvail = Number(State.balance?.onchain?.available || 0);
      $('inputAmt').value = onAvail.toFixed(2);
      applySendValidationUI();
    });

    // Enviar FONE ‚Äî pede senha do app antes de prosseguir
    $('btnSendTx')?.addEventListener('click', async () => {
      const v = validateSendForm();
      if (!v.ok) return applySendValidationUI();

      const msg = ($('inputMsg')?.value || '').trim();
      const sure = confirm(`Confirmar envio de ${v.amt} FONE para\n${v.dest}${msg ? `\n\nMensagem: ${msg}` : ''}`);
      if (!sure) return;

      if (REQUIRE_PWD_FOR_SEND) {
        const ok = await requireActionPassword({ title: 'Confirmar envio', hint: 'Digite sua senha para autorizar o envio.' });
        if (!ok) return;
      }

      const pk = (prompt('Cole sua CHAVE PRIVADA... (N√ÉO SER√Å SALVA)') || '').trim();
      if (!pk) return;

      try {
        const r = await sendTransactionFlow(pk, v.dest, v.amt, msg);
        $('sendResult').innerText = JSON.stringify(r, null, 2);
        toast('Transa√ß√£o enviada. Sincronizando...', 2500);
        setTimeout(syncAll, 1200);
        showPage('history');
      } catch (err) {
        alert('Erro ao enviar: ' + (err.message || err));
      }
    });

    // Logout ‚Äî pede senha do app e corrige typos
    $('logoutBtn')?.addEventListener('click', async () => {
      if (!confirm('Deseja realmente sair?')) return;

      if (REQUIRE_PWD_FOR_LOGOUT) {
        const ok = await requireActionPassword({ title: 'Confirmar logout', hint: 'Digite sua senha para sair.' });
        if (!ok) return;
      }

      State.wallet = null;
      State.persistedWalletAddress = null;
      try { localStorage.removeItem(LS_LAST_WALLET); } catch {}

      State.balance = {
        onchain: { available: 0, staked: 0, vested: 0, total: 0 },
        credits: 0,
        totalUI: 0,
        disponivelUI: 0
      };
      State.history = [];
      State.reputation = 0;
      State.leaderboard = {};
      State.bets = {};
      State.missions = [];
      State.completedMissionIds = [];

      buildMissions();
      buildReviewQueueAposta();
      recalcTotals();
      updateUI();

      lockApp();
      showModal('loginModal', true);
      $('welcomeModal')?.classList.remove('show');
      toast('Logout feito.', 2000);
    });

    $('cfgSdk').value = State.settings.sdkKey || '';
    $('cfgBase').value = State.settings.baseUrl || 'https://fonenetwork.ddns.net:8543';
    $('btnSaveCfg')?.addEventListener('click', () => {
      State.settings.sdkKey = ($('cfgSdk')?.value || '').trim();
      State.settings.baseUrl = ($('cfgBase')?.value || '').trim() || State.settings.baseUrl;
      localStorage.setItem(LS_SDK, State.settings.sdkKey);
      localStorage.setItem(LS_BASE, State.settings.baseUrl);
      $('cfgMsg').innerText = 'Saved Settings.';
      toast('Saved configuration.', 1600);
    });
    $('btnTestCfg')?.addEventListener('click', async () => {
      $('cfgMsg').innerText = 'Testing...';

      try {
        await api('/v1/wallet/create', 'POST');
        $('cfgMsg').innerText = 'Connection OK (test wallet created).';
        toast('Conex√£o OK', 1600);
      } catch (e) {
        $('cfgMsg').innerText = 'Failed: ' + e.message + ' (check CORS/BASE URL/SDK)';
      }
    });

    $('btnStart')?.addEventListener('click', () => {
      $('welcomeModal')?.classList.remove('show');
      showModal('loginModal', true);
      localStorage.setItem(LS_WELCOME, '1');
    });

    function ensureSdkConfigured() {
      try {
        const sdk = localStorage.getItem(LS_SDK) || '';
        const banner = $('sdkBanner');
        if (!USE_PROXY && !sdk) {
          if (banner) banner.style.display = 'flex';
          const btn = $('sdkGoSettings');
          if (btn) btn.onclick = () => {
            showPage('settings');
            $('cfgSdk')?.focus();
          };
          toast('Configure your SDK key in Settings ‚Üí Fone API', 4500);
          showPage('settings');
        } else {
          if (banner) banner.style.display = 'none';
        }
      } catch {}
    }

    function bindSaveCfgWatcher() {
      const btn = $('btnSaveCfg');
      if (!btn) return;
      btn.addEventListener('click', () => {
        setTimeout(() => ensureSdkConfigured(), 80);
      });
    }

    (function init() {
      const lastAddr = State.persistedWalletAddress;
      if (lastAddr) {
        const persisted = loadPersistentForAddress(lastAddr);
        if (persisted) {
          State.balance = persisted.balance || State.balance;
          State.history = persisted.history || [];
          State.missions = persisted.missions || [];
          State.completedMissionIds = persisted.completedMissionIds || [];
          State.leaderboard = persisted.leaderboard || {};
          State.reputation = persisted.reputation || 0;
          State.reviewQueue = persisted.reviewQueue || [];
          State.bets = persisted.bets || {};
        }
      }
      buildMissions();
      buildReviewQueueAposta();
      recalcTotals();
      const savedTheme = localStorage.getItem(LS_THEME) || 'dark';
      applyTheme(savedTheme);
      const sel = $('selTheme');
      if (sel) sel.value = savedTheme;

      if (State.persistedWalletAddress) {
        State.leaderboard[State.persistedWalletAddress] = Number(State.leaderboard[State.persistedWalletAddress] || State.reputation || 0);
      }
      updateUI();
      if (getActiveAddress()) {
        $('welcomeModal')?.classList.remove('show');
        $('loginModal')?.classList.remove('show');
        setTimeout(() => { try { syncAll(); } catch (e) {} }, 600);
      } else {
        $('welcomeModal')?.classList.remove('show');
        showModal('loginModal', true);
      }
      window.addEventListener('load', () => {
        initPasswordLock();
        bindSaveCfgWatcher();
      });
      window.Eco = { State, api, syncAll, showPage };
    })();
  </script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</body>
</html>
