<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Eco-Verify — FONE DePIN (Demo)</title>
  <link rel="shortcut icon" href="image.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --accent:#22c55e;
      --accent-2:#0ea5e9;
      --glass-border:rgba(148,163,184,.35);
      --bg:#020617;
      --card-bg:rgba(15,23,42,.78);
      --muted:#9ca3af;
      --surface:#020617;
      --input-bg:rgba(15,23,42,.94);
      --input-text:#e5e7eb;
      --code-bg:#020617;
      --body-text:#e5e7eb;
      color-scheme:dark;
    }
    :root[data-theme="light"]{
      --accent:#16a34a;
      --accent-2:#0ea5e9;
      --glass-border:rgba(148,163,184,.4);
      --bg:#e5f3ff;
      --card-bg:rgba(255,255,255,.94);
      --muted:#64748b;
      --surface:#f1f5f9;
      --input-bg:#ffffff;
      --input-text:#020617;
      --code-bg:#e5e7eb;
      --body-text:#020617;
      color-scheme:light;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--body-text);
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      scroll-behavior:smooth;
    }

    /* 3D animated background */
    .bg-scene{
      position:fixed;
      inset:0;
      overflow:hidden;
      z-index:-1;
      background:
        radial-gradient(circle at 10% 0%, rgba(56,189,248,.3), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(34,197,94,.28), transparent 55%),
        radial-gradient(circle at 20% 100%, rgba(129,140,248,.28), transparent 55%),
        radial-gradient(circle at 100% 20%, rgba(147,51,234,.26), transparent 60%);
    }
    .bg-grid{
      position:absolute;
      inset:20% -50% -40%;
      background-image:
        linear-gradient(to right, rgba(148,163,184,.18) 1px, transparent 1px),
        linear-gradient(to top, rgba(148,163,184,.14) 1px, transparent 1px);
      background-size:40px 40px;
      transform-origin:center top;
      transform:perspective(900px) rotateX(70deg) translateY(20px);
      opacity:0.6;
      filter:drop-shadow(0 10px 25px rgba(15,23,42,.9));
      animation:gridMove 18s linear infinite;
    }
    @keyframes gridMove{
      0%   { background-position:0 0, 0 0; opacity:.65; }
      50%  { background-position:0 40px, 0 20px; opacity:.45; }
      100% { background-position:0 80px,0 40px; opacity:.65; }
    }
    .bg-orb{
      position:absolute;
      border-radius:999px;
      filter:blur(16px);
      opacity:.55;
      mix-blend-mode:screen;
      pointer-events:none;
      animation:floatOrb 22s ease-in-out infinite alternate;
    }
    .bg-orb.orb-1{
      width:360px;height:360px;
      background:radial-gradient(circle at 30% 20%,rgba(56,189,248,.95),transparent 65%);
      top:-60px; left:-80px;
      animation-duration:24s;
    }
    .bg-orb.orb-2{
      width:280px;height:280px;
      background:radial-gradient(circle at 60% 40%,rgba(34,197,94,.9),transparent 65%);
      bottom:-40px; right:-40px;
      animation-duration:28s;
    }
    .bg-orb.orb-3{
      width:220px;height:220px;
      background:radial-gradient(circle at 50% 30%,rgba(147,51,234,.9),transparent 65%);
      bottom:15%; left:15%;
      animation-duration:26s;
    }
    @keyframes floatOrb{
      0%  { transform:translate3d(0,0,0) scale(1); }
      50% { transform:translate3d(20px,-30px,0) scale(1.05); }
      100%{ transform:translate3d(-10px,20px,0) scale(1.03); }
    }

    .glass{
      background:var(--card-bg);
      border:1px solid rgba(148,163,184,.28);
      backdrop-filter:blur(18px) saturate(140%);
      -webkit-backdrop-filter:blur(18px) saturate(140%);
      border-radius:18px;
      box-shadow:
        0 18px 40px rgba(15,23,42,.75),
        0 0 0 1px rgba(15,23,42,.3);
      transition:
        transform .18s ease-out,
        box-shadow .2s ease-out,
        border-color .22s ease-out,
        background .2s ease-out;
      transform-origin:center center;
    }
    .glass:hover{
      transform:translateY(-4px) translateZ(0) rotateX(1.1deg) rotateY(-0.8deg);
      box-shadow:
        0 25px 60px rgba(15,23,42,.85),
        0 0 0 1px rgba(59,130,246,.45);
      border-color:rgba(59,130,246,.65);
    }

    .btn-accent{
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      color:#021124;
      padding:.6rem .95rem;
      border-radius:.9rem;
      font-weight:700;
      border:none;
      letter-spacing:.02em;
      box-shadow:0 12px 35px rgba(34,197,94,.28);
      transform:translateY(0);
      transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn-accent:hover{
      transform:translateY(-1px);
      box-shadow:0 20px 45px rgba(34,197,94,.35);
      filter:brightness(1.04);
    }
    .btn-muted{
      background:rgba(15,23,42,.85);
      color:#cbd5e1;
      padding:.5rem .9rem;
      border-radius:.9rem;
      border:1px solid rgba(148,163,184,.4);
    }
    .btn-ghost{
      background:transparent;
      border:1px dashed rgba(148,163,184,.45);
      padding:.45rem .9rem;
      border-radius:.9rem;
      color:var(--muted);
    }
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .small-muted{
      font-size:.9rem;
      color:var(--muted);
    }
    .thumb{
      width:100%;
      max-height:260px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
    }
    .nav-link{
      display:flex;
      align-items:center;
      gap:10px;
      padding:.65rem .75rem;
      border-radius:12px;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease, color .15s ease, transform .12s ease;
    }
    .nav-link:hover{
      background:rgba(15,23,42,.75);
      color:#e5e7eb;
      transform:translateX(2px);
    }
    .nav-link.active{
      background:linear-gradient(120deg,rgba(34,197,94,.18),rgba(59,130,246,.22));
      color:var(--accent);
      font-weight:700;
    }

    @media (max-width:900px){
      #sidebar{
        position:fixed;
        left:0;
        top:0;
        height:100vh;
        z-index:70;
        transform:translateX(-110%);
        transition:transform .22s ease;
        width:82%;
        max-width:360px;
        padding:16px;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
      }
      #sidebar.open{transform:translateX(0);}
      main{padding:12px;margin-left:0;}
    }
    @media (min-width:901px){
      #sidebar{
        position:fixed;
        left:1.5rem;
        top:1.5rem;
        width:280px;
        padding:20px 18px;
        height:calc(100vh - 3rem);
        overflow-y:auto;
      }
      main{
        margin-left:340px;
        padding:24px 24px 32px;
      }
    }
    #sidebarBackdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      backdrop-filter:blur(4px);
      z-index:60;
      display:none;
    }
    .modal{
      position:fixed;
      inset:0;
      z-index:95;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,.85);
      padding:16px;
    }
    .modal.show{display:flex;}
    pre{
      white-space:pre-wrap;
      word-break:break-word;
      background:var(--code-bg);
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(30,64,175,.55);
    }
    .app-input{
      background:var(--input-bg);
      color:var(--input-text);
      border-radius:0.75rem;
      border:1px solid rgba(148,163,184,.4);
    }
    .app-input::placeholder{
      color:rgba(148,163,184,.8);
    }
    .app-surface{
      background:var(--surface);
      color:var(--input-text);
    }
    html, body, #app, .glass {
      transition:
        background 0.25s ease,
        color 0.25s ease,
        border-color 0.25s ease,
        box-shadow 0.25s ease;
    }
    [data-theme="light"] .glass{
      background:var(--card-bg);
      border-color:var(--glass-border);
      box-shadow:0 10px 25px rgba(15,23,42,.12);
    }
    [data-theme="light"] .btn-muted{
      background:#e5e7eb;
      color:#111827;
      border-color:#cbd5e1;
    }
    [data-theme="light"] .btn-ghost{
      background:transparent;
      border-color:#cbd5e1;
      color:#475569;
    }
    [data-theme="light"] .app-surface{
      background:#ffffff;
      color:#020617;
    }
    [data-theme="light"] pre{
      border-color:#d4d4d8;
    }
  </style>
</head>
<body>
  <!-- 3D animated background -->
  <div class="bg-scene">
    <div class="bg-grid"></div>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>
  </div>

  <div id="app" class="min-h-screen relative" data-theme="dark">
    <aside id="sidebar" class="glass md:block">
      <div class="flex items-center gap-3 mb-6">
        <img src="image.png" alt="ecoverify-logo" width="80" height="80" style="border-radius:18px;"/>
        <div>
          <div class="font-bold tracking-tight text-lg">Eco-Verify</div>
          <div class="small-muted">FONE • DePIN (Demo)</div>
        </div>
      </div>
      <nav class="flex flex-col gap-1.5 mb-6 text-sm">
        <div class="nav-link active" data-route="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard</div>
        <div class="nav-link" data-route="missions"><i data-lucide="map-pin" class="w-4 h-4"></i> Missions</div>
        <div class="nav-link" data-route="leaderboard"><i data-lucide="award" class="w-4 h-4"></i> Leaderboard</div>
        <div class="nav-link" data-route="aposta"><i data-lucide="activity" class="w-4 h-4"></i> Betting</div>
        <div class="nav-link" data-route="send"><i data-lucide="send" class="w-4 h-4"></i> Send/Withdraw</div>
        <div class="nav-link" data-route="receive"><i data-lucide="qr-code" class="w-4 h-4"></i> Receive</div>
        <div class="nav-link" data-route="history"><i data-lucide="clock" class="w-4 h-4"></i> History</div>
        <div class="nav-link" data-route="settings"><i data-lucide="settings-2" class="w-4 h-4"></i> Settings</div>
      </nav>
      <div class="mt-auto text-xs small-muted space-y-2 pb-[env(safe-area-inset-bottom)]">
        <div>Wallet: <div id="sidebarAddr" class="mono text-sm break-all mt-0.5">—</div></div>
        <div>Reputation: <div id="sidebarRep" class="mono text-sm mt-0.5">0</div></div>
        <div class="mt-3"><button id="logoutBtn" class="btn-muted w-full">Logout</button></div>
      </div>
    </aside>

    <div id="sidebarBackdrop" class="md:hidden"></div>

    <header class="md:hidden p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="image.png" alt="ecoverify-logo" width="48" height="48" style="border-radius:14px;"/>
        <div>
          <div class="font-bold">Eco-Verify</div>
          <div class="small-muted text-xxs">Demo • local only</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="mobileMenuBtn" class="btn-muted px-3 py-1 text-xs">Menu</button>
        <button id="mobileLoginBtn" class="btn-accent px-3 py-1 text-xs">Connect</button>
      </div>
    </header>

    <main>
      <div class="flex flex-col md:flex-row justify-between items-stretch md:items-start gap-4 mb-6 p-3 md:p-0">
        <div>
          <h1 id="pageTitle" class="font-bold text-xl md:text-2xl tracking-tight">Dashboard</h1>
          <p class="text-sm small-muted" id="pageSub">
            Explore missions, demo FONE transfers and reputation — all simulated locally.
          </p>
        </div>
        <div class="flex flex-col gap-2 md:items-end w-full md:w-auto">
          <div class="glass p-3 rounded-xl text-right w-full md:w-[380px]">
            <div class="flex items-center justify-between text-xs small-muted">
              <span>On-chain FONE balance (demo)</span>
              <span class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                <span>Local only</span>
              </span>
            </div>
            <div id="topBalance" class="text-2xl md:text-3xl font-bold mono mt-1.5">0.00 FONE</div>
            <div id="topBreakdown" class="text-xs small-muted mt-1">On-chain: 0.00 FONE</div>
            <div class="text-xs small-muted mt-2">Address</div>
            <div id="topAddr" class="mono text-[11px] md:text-xs break-words mt-0.5">—</div>
          </div>
          <div class="flex gap-2 justify-end">
            <button id="themeToggle" class="btn-ghost px-3 py-2 text-xs md:text-sm flex items-center gap-1.5">
              <i data-lucide="sun-moon" class="w-4 h-4"></i> Theme
            </button>
            <button id="openLoginBtn" class="btn-accent px-3 py-2 text-xs md:text-sm flex items-center gap-1.5">
              <i data-lucide="link-2" class="w-4 h-4"></i> Connect
            </button>
          </div>
          <div class="text-[11px] small-muted text-right max-w-xs md:max-w-sm ml-auto">
            Demo mode: all balances, missions and betting are simulated in this browser. No real FONE is moved and no backend is required.
          </div>
        </div>
      </div>

      <section id="pages" class="p-3 md:p-0">
        <!-- DASHBOARD -->
        <div id="page-dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
          <div class="lg:col-span-2 space-y-4">
            <div class="glass p-5 md:p-6">
              <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div>
                  <h2 class="font-bold text-lg">Wallet</h2>
                  <div class="text-sm small-muted">Manage your demo wallet and activity.</div>
                  <div class="mt-3 space-y-1">
                    <div class="mono break-all text-xs md:text-sm" id="walletAddressDisplay">—</div>
                    <div class="text-xs small-muted flex items-center gap-2">
                      Status:
                      <span id="uiMode" class="inline-flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-sky-400 animate-pulse"></span>
                        demo (offline)
                      </span>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <button id="openWalletHistory" class="btn-accent text-sm md:text-base flex items-center gap-1.5 justify-center">
                    <i data-lucide="history" class="w-4 h-4"></i> History
                  </button>
                  <div class="mt-2">
                    <button id="btnSyncAll" class="btn-muted text-xs md:text-sm w-full md:w-auto flex items-center gap-1.5 justify-center">
                      <i data-lucide="refresh-cw" class="w-3 h-3 md:w-4 md:h-4"></i> Sync balance
                    </button>
                  </div>
                  <div class="text-xs small-muted mt-2">
                    Reputation: <strong id="repScore">0</strong> pts
                  </div>
                </div>
              </div>
            </div>

            <div class="glass p-5 md:p-6">
              <div class="flex items-center justify-between">
                <h3 class="font-bold">Nearby missions</h3>
                <div class="text-sm text-teal-300 cursor-pointer flex items-center gap-1" data-route="missions">
                  See all <i data-lucide="arrow-right" class="w-3 h-3"></i>
                </div>
              </div>
              <div id="miniMissions" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>

            <div class="glass p-5 md:p-6">
              <h3 class="font-bold">How it works (demo)</h3>
              <ol class="text-sm small-muted list-decimal list-inside mt-2 space-y-2">
                <li>Create or import a demo FONE wallet. Keys stay only in this browser.</li>
                <li>Complete missions to earn <strong>reputation</strong> and simulated rewards (“credits”).</li>
                <li>Use Betting and Send/Withdraw screens to explore possible on-chain flows in a safe sandbox.</li>
              </ol>
              <div class="mt-3 text-xs small-muted">
                In a production deployment, this interface would connect to a backend and a real FONE node.
                For this public prototype, everything runs client-side for safety and ease of testing.
              </div>
            </div>
          </div>

          <aside class="space-y-4">
            <div class="glass p-4">
              <h4 class="font-bold">Quick actions</h4>
              <div class="mt-3 grid gap-3 text-sm">
                <button data-route="missions" class="btn-accent w-full flex items-center justify-center gap-1.5">
                  <i data-lucide="check-circle-2" class="w-4 h-4"></i> Complete a mission
                </button>
                <button data-route="leaderboard" class="btn-muted w-full flex items-center justify-center gap-1.5">
                  <i data-lucide="trophy" class="w-4 h-4"></i> View ranking
                </button>
                <button data-route="send" class="btn-muted w-full flex items-center justify-center gap-1.5">
                  <i data-lucide="send" class="w-4 h-4"></i> Send / Withdraw
                </button>
                <button data-route="receive" class="btn-muted w-full flex items-center justify-center gap-1.5">
                  <i data-lucide="qr-code" class="w-4 h-4"></i> Receive (QR)
                </button>
              </div>
            </div>

            <div class="glass p-4">
              <h4 class="font-bold">Quick missions</h4>
              <ul id="sideMissionList" class="mt-3 text-sm small-muted space-y-2"></ul>
            </div>
          </aside>
        </div>

        <!-- MISSIONS -->
        <div id="page-missions" class="hidden">
          <div class="glass p-5 md:p-6">
            <h2 class="font-bold text-lg">Missions</h2>
            <p class="text-sm small-muted">Click “Complete mission” to submit a photo and report (simulated validation).</p>
            <div id="missionsList" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </div>
        </div>

        <!-- COMPLETE MISSION -->
        <div id="page-upload" class="hidden">
          <div class="glass p-5 md:p-6 max-w-3xl">
            <h2 class="font-bold text-lg">Complete mission</h2>
            <div class="text-sm small-muted mt-1" id="uploadMissionTitle">Mission</div>
            <label class="block mt-4 text-sm">Photo (attach):
              <input id="fileInput" accept="image/*" type="file" class="mt-2 w-full text-xs" />
            </label>
            <div id="previewWrap" class="mt-4 hidden">
              <img id="previewImg" class="thumb" src="" alt="preview" />
            </div>
            <label class="block mt-4 text-sm">Report:
              <textarea id="reportText" rows="5" class="w-full mt-2 p-3 rounded app-input text-sm" placeholder="Describe the evidence, location, and impact..."></textarea>
            </label>
            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <button id="btnSubmitProof" class="btn-accent flex-1">Submit proof and complete mission</button>
              <button id="btnCancelUpload" class="btn-muted flex-1">Cancel</button>
            </div>
            <div id="missionNotice" class="hidden mt-4 glass p-4">
              <div class="font-semibold mb-1">Mission approved ✅ (demo)</div>
              <div id="missionDetails" class="text-sm small-muted"></div>
            </div>
          </div>
        </div>

        <!-- BETTING -->
        <div id="page-aposta" class="hidden">
          <div class="glass p-5 md:p-6 max-w-5xl">
            <h2 class="font-bold text-lg">Betting (demo)</h2>
            <p class="text-sm small-muted">
              Bet up to <strong>100 demo FONE</strong> by reviewing other users’ cases. If you follow the majority,
              you receive your stake + 75%. All values here are simulated and local to this device.
            </p>
            <div class="mt-3 text-sm small-muted">
              Demo balance (simulated “credits”): <strong class="mono" id="apostaCredits">1000.00</strong> FONE
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="apostaList"></div>
            <div class="mt-4 small-muted text-xs">
              Note: bets use a <strong>local, simulated balance</strong> (“demo FONE”) and do not
              affect any real blockchain assets.
            </div>
          </div>
        </div>

        <!-- SEND -->
        <div id="page-send" class="hidden">
          <div class="glass p-5 md:p-6 max-w-2xl">
            <h2 class="font-bold text-lg">Send / Withdraw FONE (demo)</h2>
            <div class="mt-2 text-sm small-muted">
              <div>Available (demo on-chain): <strong id="sendAvail" class="mono">0.00</strong> FONE</div>
              <div class="mt-1" id="feeInfo">Network fee: simulated — no real network calls.</div>
            </div>

            <div class="mt-2 text-xs small-muted">
              This public demo simulates sending FONE locally, without contacting any backend or node.
              In a production environment, this screen would sign and broadcast real FONE transactions.
            </div>

            <label class="block mt-4 text-sm">Destination address
              <div class="flex gap-2 mt-2">
                <input id="inputDest" list="contactsData" class="flex-1 p-3 rounded app-input mono text-xs md:text-sm" placeholder="Demo FONE address (f..., 0x..., ...)" />
                <button id="btnScanQR" type="button" class="btn-muted text-xs px-3">Scan QR</button>
                <button id="btnSaveContact" type="button" class="btn-ghost text-xs px-3">Save</button>
              </div>
              <datalist id="contactsData"></datalist>
              <div id="helpDest" class="mt-1 text-xs small-muted">Scan a QR or choose from your saved contacts.</div>
            </label>

            <!-- QR scanner modal -->
            <div id="scanModal" class="modal">
              <div class="glass p-4 w-full max-w-md rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-bold">Scan QR</h3>
                  <button id="qrClose" class="btn-muted text-xs px-3">Close</button>
                </div>
                <div id="qr-reader" style="width:100%;"></div>
                <div class="small-muted mt-2 text-xs">Allow camera access (if available on this device).</div>
              </div>
            </div>

            <label class="block mt-3 text-sm">Amount (FONE)
              <div class="flex items-center gap-2 mt-2">
                <input id="inputAmt" type="number" step="0.01" inputmode="decimal" pattern="[0-9]*" class="flex-1 p-3 rounded app-input mono text-xs md:text-sm" />
                <button id="btnMax" class="btn-ghost px-3 py-2 text-xs">MAX</button>
              </div>
              <div class="mt-1 text-xs small-muted">You can (simulatively) send up to your available demo balance.</div>
            </label>

            <label class="block mt-3 text-sm">Message (optional)
              <input id="inputMsg" maxlength="100" class="w-full mt-2 p-3 rounded app-input text-xs md:text-sm" />
              <div class="mt-1 text-xs small-muted">Optional, up to 100 characters.</div>
            </label>

            <div id="sendPreview" class="mt-4 hidden p-3 rounded app-surface text-sm"></div>
            <div id="sendErrors" class="mt-3 text-sm text-red-300"></div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <button id="btnSendTx" class="btn-accent flex-1 text-sm">Send (demo)</button>
              <button id="btnSyncBal" class="btn-muted flex-1 text-sm">Sync (no-op in demo)</button>
            </div>
            <pre id="sendResult" class="mt-4 text-xs md:text-sm mono small-muted"></pre>
          </div>
        </div>

        <!-- RECEIVE -->
        <div id="page-receive" class="hidden">
          <div class="glass p-5 md:p-6 max-w-2xl">
            <h2 class="font-bold text-lg">Receive FONE (demo)</h2>
            <p class="text-sm small-muted mt-1">Share your address or QR code. In this demo, no real transfers happen.</p>
            <div class="mt-4">
              <div class="text-xs small-muted">Your address</div>
              <div id="receiveAddr" class="mono mt-1 break-all text-xs md:text-sm">—</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btnCopyAddr" class="btn-accent text-xs md:text-sm flex items-center gap-1.5">
                  <i data-lucide="copy" class="w-3 h-3"></i> Copy address
                </button>
                <button id="btnShareAddr" class="btn-muted text-xs md:text-sm flex items-center gap-1.5">
                  <i data-lucide="share-2" class="w-3 h-3"></i> Share
                </button>
                <button id="btnDownloadQR" class="btn-muted text-xs md:text-sm flex items-center gap-1.5">
                  <i data-lucide="download" class="w-3 h-3"></i> Download QR
                </button>
              </div>
            </div>

            <div class="mt-5">
              <div class="text-xs small-muted mb-2">QR Code</div>
              <div id="qrWrap" class="inline-block p-3 rounded bg-white shadow-lg">
                <div id="qrCode"></div>
              </div>
            </div>

            <div class="mt-5 text-sm small-muted">
              Only send real FONE on supported wallets and networks. This demo does not receive any
              on-chain transfers and is safe to explore.
            </div>
          </div>
        </div>

        <!-- LEADERBOARD -->
        <div id="page-leaderboard" class="hidden">
          <div class="glass p-5 md:p-6 max-w-3xl">
            <h2 class="font-bold text-lg">Leaderboard — Reputation</h2>
            <p class="text-sm small-muted">Ranking by reputation points (simulated, local to this browser).</p>
            <div id="leaderboardList" class="mt-4 space-y-2"></div>
          </div>
        </div>

        <!-- HISTORY -->
        <div id="page-history" class="hidden">
          <div class="glass p-5 md:p-6">
            <h2 class="font-bold text-lg">History</h2>
            <div id="historyList" class="mt-4 space-y-2 small-muted"></div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div id="page-settings" class="hidden">
          <div class="glass p-5 md:p-6 max-w-2xl">
            <h2 class="font-bold text-lg">Settings</h2>
            <div class="mt-4 grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm">Language
                  <select id="selLang" class="mt-2 p-2 rounded app-input text-sm">
                    <option value="en">English (US)</option>
                    <option value="pt">Portuguese (pt-BR)</option>
                  </select>
                </label>
                <label class="block mt-4 text-sm">Theme
                  <select id="selTheme" class="mt-2 p-2 rounded app-input text-sm">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                  </select>
                </label>
                <label class="block mt-4 text-sm">Privacy Policy
                  <textarea rows="4" readonly class="w-full mt-2 p-2 rounded app-input text-xs small-muted">
Private keys are NEVER saved on servers. In this public demo, all cryptographic operations and wallet data stay in your browser only.</textarea>
                </label>
              </div>
              <div>
                <h3 class="font-bold text-sm">Backend / Node</h3>
                <p class="mt-2 text-sm small-muted">
                  This demo runs fully client-side. No backend or FONE node is required. In a real
                  deployment, this UI would talk to a backend that connects to a FONE node.
                </p>
                <div class="mt-3 flex gap-2">
                  <button id="btnTestCfg" class="btn-muted text-xs md:text-sm flex items-center gap-1.5">
                    <i data-lucide="wifi-off" class="w-3 h-3"></i> Test (demo)
                  </button>
                </div>
                <div id="cfgMsg" class="small-muted mt-2 text-xs"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- TOAST -->
    <div id="toast" style="position:fixed;right:12px;bottom:12px;z-index:90;display:flex;flex-direction:column;gap:8px;max-width:90vw;"></div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal">
      <div class="glass p-6 w-full max-w-2xl rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-xl">Create or Import Wallet</h2>
          <div class="text-sm small-muted">Your private key is sensitive — never share it.</div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-bold text-sm">Create new wallet (demo)</h3>
            <p class="text-xs small-muted">Generates a demo address and private key (shown once, only in this browser).</p>
            <div class="mt-3 flex gap-3"><button id="btnCreateWallet" class="btn-accent w-full text-sm">Create wallet</button></div>
            <div id="createdResult" class="mt-3 text-xs mono small-muted"></div>
          </div>
          <div>
            <h3 class="font-bold text-sm">Import wallet (demo)</h3>
            <p class="text-xs small-muted">Paste a private key. The address is derived locally for this prototype.</p>
            <input id="inputPrivate" class="mt-2 p-3 rounded app-input mono w-full text-xs" type="password" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="Private key..." />
            <div class="mt-3 flex gap-3"><button id="btnImportWallet" class="btn-muted w-full text-sm">Import</button></div>
            <div id="importResult" class="mt-3 text-xs mono small-muted"></div>
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button id="closeLogin" class="btn-muted text-sm">Close</button>
        </div>
      </div>
    </div>

    <!-- PRIVATE KEY MODAL -->
    <div id="privModal" class="modal">
      <div class="glass p-6 w-full max-w-lg rounded-xl">
        <h3 class="font-bold text-lg">⚠️ Save your private key</h3>
        <p class="mt-2 text-sm small-muted">This is the only time the private key will be displayed.</p>
        <pre id="privText" class="mono mt-3 p-3 rounded text-xs small-muted"></pre>
        <div class="mt-4 flex gap-3">
          <button id="btnCopyPriv" class="btn-accent text-sm">Copy</button>
          <button id="btnPrivSaved" class="btn-muted text-sm">I have saved it — continue</button>
        </div>
      </div>
    </div>

    <!-- WELCOME MODAL -->
    <div id="welcomeModal" class="modal">
      <div class="glass p-6 w-full max-w-lg rounded-xl text-center">
        <h3 class="font-bold text-xl mb-2">Welcome to Eco-Verify (demo)</h3>
        <p class="text-sm small-muted">Explore missions, demo FONE transfers and reputation in a safe, local sandbox.</p>
        <div class="mt-5 flex gap-3 justify-center">
          <button id="btnStart" class="btn-accent px-6 text-sm">Get started</button>
        </div>
      </div>
    </div>

    <!-- GATE PASSWORD MODAL -->
    <div id="gate" class="modal">
      <div class="glass p-6 w-full max-w-sm rounded-xl">
        <h3 class="font-bold text-lg mb-2">App password</h3>

        <div id="gateCreateView">
          <p class="small-muted text-sm">Create a password to lock/unlock your wallet on this device.</p>
          <label class="block mt-3 text-sm">Password
            <input id="newPass" type="password" class="mt-2 p-3 rounded app-input w-full text-sm" autocomplete="new-password">
          </label>
          <label class="block mt-3 text-sm">Confirm password
            <input id="newPass2" type="password" class="mt-2 p-3 rounded app-input w-full text-sm" autocomplete="new-password">
          </label>
          <div class="mt-4 flex gap-2">
            <button id="gateCreateBtn" class="btn-accent w-full text-sm">Create password</button>
          </div>
          <div id="gateMsg" class="small-muted mt-2 text-xs"></div>
        </div>

        <div id="gateUnlockView" class="hidden">
          <p class="small-muted text-sm">Enter your app password to continue.</p>
          <input id="gatePass" type="password" class="mt-3 p-3 rounded app-input w-full text-sm" autocomplete="current-password">
          <div class="mt-4 flex gap-2">
            <button id="gateBtn" class="btn-accent w-full text-sm">Unlock</button>
          </div>
          <div id="gateMsg2" class="small-muted mt-2 text-xs"></div>
        </div>
      </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="authModal" class="modal">
      <div class="glass p-6 w-full max-w-sm rounded-xl">
        <h3 id="authTitle" class="font-bold text-lg mb-2">Confirm action</h3>
        <p id="authHint" class="small-muted text-sm">Enter your password to continue.</p>
        <input id="authPass" type="password" class="mt-3 p-3 rounded app-input w-full text-sm" autocomplete="current-password">
        <div class="mt-4 flex gap-2">
          <button id="authCancel" class="btn-muted w-1/2 text-sm">Cancel</button>
          <button id="authOk" class="btn-accent w-1/2 text-sm">Confirm</button>
        </div>
        <div id="authMsg" class="small-muted mt-2 text-xs"></div>
      </div>
    </div>
  </div>

  <script>
    const DEMO_MODE = true;

    const LS_LAST_WALLET = 'ev_last_wallet';
    const LS_WALLET_PREFIX = 'ev_wallet_';
    const LS_THEME = 'ev_theme';
    const LS_WELCOME = 'ev_welcome_seen';
    const GATE_FLAG = 'ev_gate_ok';

    const PASS_SALT = 'ev_pass_salt';
    const PASS_VER = 'ev_pass_ver';
    const PASS_ITER = 'ev_pass_iter';
    const SS_PK_PREFIX = 'ev_pk_';

    const REQUIRE_PWD_FOR_SEND = true;
    const REQUIRE_PWD_FOR_LOGOUT = true;

    const enc = new TextEncoder();
    const toHex = (u8) => Array.from(u8).map(b => b.toString(16).padStart(2,'0')).join('');
    const fromHex = (hex) => new Uint8Array((hex.match(/.{2}/g)||[]).map(h => parseInt(h,16)));

    function demoRandomHex(bytes=32){
      const arr = crypto.getRandomValues(new Uint8Array(bytes));
      return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function demoRandomAddr(){
      return 'f' + demoRandomHex(20);
    }
    function demoAddrFromPk(pk){
      const h = Array.from(enc.encode(pk)).map(b=>b.toString(16).padStart(2,'0')).join('');
      return 'f' + h.slice(0, 40);
    }

    async function deriveHex(pass, saltHex, iter) {
      const keyMat = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: fromHex(saltHex), iterations: iter, hash: 'SHA-256' },
        keyMat, 256
      );
      return toHex(new Uint8Array(bits));
    }
    async function setAppPassword(pass) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const saltHex = toHex(salt);
      const iter = 150000;
      const ver = await deriveHex(pass, saltHex, iter);
      localStorage.setItem(PASS_SALT, saltHex);
      localStorage.setItem(PASS_ITER, String(iter));
      localStorage.setItem(PASS_VER, ver);
    }
    async function verifyAppPassword(pass) {
      const saltHex = localStorage.getItem(PASS_SALT);
      const iter = parseInt(localStorage.getItem(PASS_ITER) || '150000', 10);
      const ver = localStorage.getItem(PASS_VER);
      if (!saltHex || !ver) return false;
      const check = await deriveHex(pass, saltHex, iter);
      return check === ver;
    }
    function isPasswordSet() { return !!localStorage.getItem(PASS_VER); }
    function isUnlocked() { return sessionStorage.getItem(GATE_FLAG) === '1'; }
    function setUnlocked(flag) {
      if (flag) sessionStorage.setItem(GATE_FLAG, '1');
      else sessionStorage.removeItem(GATE_FLAG);
    }

    const State = {
      wallet: null,
      persistedWalletAddress: localStorage.getItem(LS_LAST_WALLET) || null,
      balance: {
        onchain: { available: 0, staked: 0, vested: 0, total: 0 },
        totalUI: 0,
        disponivelUI: 0
      },
      history: [],
      missions: [],
      completedMissionIds: [],
      leaderboard: {},
      reputation: 0,
      reviewQueue: [],
      bets: {},
      syncing: false,
      demoBetBalance: 1000
    };
    const $ = (id) => document.getElementById(id);

    function applyTheme(theme) {
      const t = theme === 'light' ? 'light' : 'dark';
      const root = document.documentElement;
      root.setAttribute('data-theme', t);
      const app = $('app');
      if (app) app.setAttribute('data-theme', t);
    }

    function toast(msg, time = 3200, type = 'info') {
      const colors = {
        success: 'border-emerald-500 text-emerald-200',
        error: 'border-rose-500 text-rose-200',
        warning: 'border-amber-500 text-amber-200',
        info: 'border-sky-500 text-sky-200'
      };
      const el = document.createElement('div');
      el.className = `glass p-3 border ${colors[type] || colors.info}`;
      el.style.minWidth = '220px';
      el.innerHTML = `<div class="font-medium text-sm">${msg}</div>`;
      $('toast')?.appendChild(el);
      setTimeout(() => el.remove(), time);
    }

    function showModal(id, show = true) {
      const el = $(id);
      if (!el) return;
      if (show) el.classList.add('show');
      else el.classList.remove('show');
    }

    function savePersistentForAddress(addr) {
      if (!addr) return;
      const payload = {
        address: addr,
        balance: State.balance,
        history: State.history,
        missions: State.missions,
        completedMissionIds: State.completedMissionIds,
        leaderboard: State.leaderboard,
        reputation: State.reputation,
        reviewQueue: State.reviewQueue,
        bets: State.bets,
        demoBetBalance: State.demoBetBalance
      };
      try {
        localStorage.setItem(LS_WALLET_PREFIX + addr, JSON.stringify(payload));
        localStorage.setItem(LS_LAST_WALLET, addr);
      } catch {}
    }

    function loadPersistentForAddress(addr) {
      try {
        const raw = localStorage.getItem(LS_WALLET_PREFIX + addr);
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    function savePrivateKeySession(addr, pk) {
      if (!addr || !pk) return;
      try { sessionStorage.setItem(SS_PK_PREFIX + addr, pk); } catch {}
    }
    function getPrivateKeySession(addr) {
      if (!addr) return null;
      try { return sessionStorage.getItem(SS_PK_PREFIX + addr) || null; } catch { return null; }
    }
    function clearPrivateKeySession(addr) {
      if (!addr) return;
      try { sessionStorage.removeItem(SS_PK_PREFIX + addr); } catch {}
    }

    function recalcTotals() {
      const onTotal = Number(State.balance.onchain.total || 0);
      const onAvail = Number(State.balance.onchain.available || 0);
      State.balance.totalUI = onTotal;
      State.balance.disponivelUI = onAvail;
    }

    function updateUI() {
      const onTotal = Number(State.balance.onchain.total || 0);
      const onAvail = Number(State.balance.onchain.available || 0);

      $('topBalance').innerText = `${onTotal.toFixed(2)} FONE`;
      $('topBreakdown').innerText = `On-chain balance (demo): ${onTotal.toFixed(2)} FONE`;

      const addr = getActiveAddress() || '—';
      $('topAddr').innerText = addr;
      $('walletAddressDisplay').innerText = addr;
      $('sidebarAddr').innerText = addr;
      $('sidebarRep').innerText = State.reputation || 0;
      $('repScore').innerText = State.reputation || 0;

      $('sendAvail').innerText = onAvail.toFixed(2);

      const hasWallet = !!getActiveAddress();
      if ($('logoutBtn')) $('logoutBtn').style.display = hasWallet ? 'block' : 'none';
      if ($('openLoginBtn')) $('openLoginBtn').style.display = hasWallet ? 'none' : 'inline-flex';
      if ($('mobileLoginBtn')) $('mobileLoginBtn').style.display = hasWallet ? 'none' : 'inline-flex';

      renderMiniMissions();
      renderMissionsPage();
      renderLeaderboard();
      renderHistory();
      renderApostaPage();
      if ($('page-receive') && !$('page-receive').classList.contains('hidden')) renderReceivePage();
      applySendValidationUI();
      savePersistentForAddress(getActiveAddress());

      try { lucide.createIcons(); } catch {}
    }

    function showPage(name) {
      document.querySelectorAll('[id^="page-"]').forEach(s => s.classList.add('hidden'));
      const page = $('page-' + name);
      if (page) page.classList.remove('hidden');
      document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
      const nav = Array.from(document.querySelectorAll('.nav-link')).find(n => n.dataset && n.dataset.route === name);
      if (nav) nav.classList.add('active');
      const map = {
        dashboard: 'Dashboard',
        missions: 'Missions',
        send: 'Send / Withdraw',
        receive: 'Receive',
        history: 'History',
        settings: 'Settings',
        upload: 'Complete mission',
        leaderboard: 'Leaderboard',
        aposta: 'Betting'
      };
      $('pageTitle').innerText = map[name] || 'Eco-Verify';
    }

    function getActiveAddress() {
      return State.wallet?.address || State.persistedWalletAddress || null;
    }

    async function deriveHexWrapper(pass) {
      const saltHex = localStorage.getItem(PASS_SALT);
      const iter = parseInt(localStorage.getItem(PASS_ITER) || '150000', 10);
      if (!saltHex) return null;
      return deriveHex(pass, saltHex, iter);
    }

    function isValidFoneAddress(a) {
      if (typeof a !== 'string') return false;
      const s = a.trim();
      return /^[a-zA-Z0-9]{6,120}$/.test(s);
    }

    function validateSendForm() {
      const dest = ($('inputDest')?.value || '').trim();
      const amt = Number($('inputAmt')?.value);
      const onAvail = Number(State.balance?.onchain?.available || 0);
      const errs = [];
      if (!dest) errs.push('Destination address is required.');
      else if (!isValidFoneAddress(dest)) errs.push('Invalid address.');
      if (!amt || !Number.isFinite(amt) || amt <= 0) errs.push('Enter a valid amount.');
      if (Number.isFinite(amt) && amt > 0 && amt > onAvail) {
        errs.push('Insufficient demo balance.');
      }
      if (getActiveAddress() && dest === getActiveAddress()) errs.push('Do not send to your own address.');
      return { ok: errs.length === 0, dest, amt, errors: errs };
    }

    function applySendValidationUI() {
      const res = validateSendForm();
      const btn = $('btnSendTx');
      const errBox = $('sendErrors');
      const prev = $('sendPreview');
      if (btn) btn.disabled = !res.ok;
      if (errBox) errBox.innerHTML = res.errors.map(e => `<div>• ${e}</div>`).join('');
      if (prev) {
        if (res.ok) {
          prev.classList.remove('hidden');
          prev.innerHTML = `<div class="small-muted">Summary (demo)</div><div class="mt-1">You will send <strong>${res.amt}</strong> FONE to <span class="mono">${res.dest}</span></div>`;
        } else {
          prev.classList.add('hidden');
          prev.innerHTML = '';
        }
      }
    }

    async function sendTransactionFlow(privateKey, recipient, amount, message) {
      const amt = Number(amount);
      State.balance.onchain.available = Math.max(0, Number(State.balance.onchain.available || 0) - amt);
      State.balance.onchain.total = State.balance.onchain.available;
      recalcTotals();
      const me = getActiveAddress() || 'demo';
      const line = `[${new Date().toLocaleString()}] Sent (demo) ${amt} FONE -> ${recipient}${message ? ' ('+message+')':''}`;
      State.history.push(line);
      return { ok: true, demo: true, sender: me, recipient, amount: amt, message };
    }

    function buildMissions() {
      if (State.missions && State.missions.length) return;
      State.missions = [
        { id: 'M1', title: 'Check recycling bins — Jaqueira Park', difficulty: 'easy', reward: 20, location: 'Recife, PE', description: 'Take a photo of the trash bin with separated materials.' },
        { id: 'M2', title: 'Photograph planted trees — Rua X', difficulty: 'medium', reward: 30, location: 'Recife, PE', description: 'Show the tree with identification or a sign.' },
        { id: 'M3', title: 'Electronic waste drop-off — Official point', difficulty: 'medium', reward: 25, location: 'Olinda, PE', description: 'Photo of the drop-off point and ticket or proof.' },
        { id: 'M4', title: 'Water saving record', difficulty: 'easy', reward: 12, location: 'Home', description: 'Photo of the meter before/after or a fixed leaking tap.' },
        { id: 'M5', title: 'Used cooking oil delivery', difficulty: 'medium', reward: 18, location: 'Collection point', description: 'Photo of the container at the collection point with a label.' },
        { id: 'M6', title: 'Clothes donation proof', difficulty: 'easy', reward: 15, location: 'Local NGO', description: 'Photo of the receipt or donation location.' },
        { id: 'M7', title: 'Community cleanup', difficulty: 'hard', reward: 22, location: 'Central square', description: 'Show before and after the cleanup.' }
      ];
    }

    function repFor(d) {
      return d === 'easy' ? 5 : d === 'medium' ? 10 : d === 'hard' ? 20 : 0;
    }

    function renderMiniMissions() {
      const el = $('miniMissions');
      const side = $('sideMissionList');
      if (!el || !side) return;
      el.innerHTML = '';
      side.innerHTML = '';
      const available = State.missions.filter(m => !State.completedMissionIds.includes(m.id));
      available.slice(0, 4).forEach(m => {
        el.innerHTML += `<div class="p-4 rounded-xl app-surface border border-slate-700/60">
          <div class="font-semibold text-sm">${m.title}</div>
          <div class="text-xs small-muted mt-0.5">${m.location} • ${m.reward} FONE (sim.)</div>
          <div class="mt-3">
            <button class="btn-accent w-full text-xs" onclick="openMission('${m.id}')">Complete mission</button>
          </div>
        </div>`;
      });
      State.missions.forEach(m => {
        if (!State.completedMissionIds.includes(m.id)) {
          side.innerHTML += `<li class="flex justify-between items-center">
            <span>${m.title}</span>
            <span class="text-xs small-muted">${m.reward} F (sim.)</span>
          </li>`;
        }
      });
    }

    function renderMissionsPage() {
      const list = $('missionsList');
      if (!list) return;
      list.innerHTML = '';
      State.missions.forEach(m => {
        const done = State.completedMissionIds.includes(m.id);
        const prog = done ? 100 : Math.floor(Math.random() * 60);
        const rep = repFor(m.difficulty);
        const card = document.createElement('div');
        card.className = 'glass p-4';
        card.innerHTML = `
          <div class="font-semibold">${m.title}</div>
          <div class="text-sm small-muted mt-1">${m.description}</div>
          <div class="text-xs small-muted mt-2">${m.location} • Reward: <strong>${m.reward} FONE</strong> (simulated) • <em>${m.difficulty.toUpperCase()}</em></div>
          <div class="mt-3">
            <div class="w-full h-2.5 bg-black/20 rounded-full overflow-hidden">
              <div class="h-2.5 rounded-full" style="width:${prog}%; background:linear-gradient(90deg, var(--accent), var(--accent-2))"></div>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <div class="text-xs small-muted">${prog}% complete</div>
              <div class="ml-auto">
                ${done ? '<span class="small-muted text-xs">Completed ✅</span>' : `<button class="btn-accent text-xs" onclick="openMission('${m.id}')">Complete mission</button>`}
              </div>
            </div>
          </div>
          <div class="mt-3 text-xs small-muted">Reputation points: ${rep}</div>`;
        list.appendChild(card);
      });
    }

    window.openMission = function openMission(id) {
      const m = State.missions.find(x => x.id === id);
      if (!m) return toast('Mission not found.', 2500, 'error');
      if (!getActiveAddress()) return toast('Connect your wallet first.', 2500, 'warning');
      $('uploadMissionTitle').innerText = `${m.title} • Reward: ${m.reward} FONE (simulated)`;
      sessionStorage.setItem('currentMission', JSON.stringify(m));
      $('fileInput').value = '';
      $('reportText').value = '';
      $('previewWrap').classList.add('hidden');
      $('missionNotice').classList.add('hidden');
      showPage('upload');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    $('fileInput')?.addEventListener('change', (ev) => {
      const f = ev.target.files[0];
      if (!f) return;
      $('previewImg').src = URL.createObjectURL(f);
      $('previewWrap').classList.remove('hidden');
    });

    let missionSubmitting = false;
    function uploadStaging() {
      return new Promise(r => setTimeout(r, 400));
    }
    $('btnCancelUpload')?.addEventListener('click', () => showPage('missions'));
    $('btnSubmitProof')?.addEventListener('click', async () => {
      if (missionSubmitting) return;
      const m = JSON.parse(sessionStorage.getItem('currentMission') || 'null');
      if (!m) return toast('Session expired. Open the mission again.', 2500, 'error');
      const file = $('fileInput').files[0];
      const report = $('reportText').value.trim();
      if (!file) return alert('Select a photo.');
      if (!report || report.length < 10) return toast('Write a report with at least 10 characters.', 2500, 'warning');
      missionSubmitting = true;
      toast('Validating mission… (simulated)', 1800, 'info');
      try {
        await uploadStaging();
        await new Promise(r => setTimeout(r, 600));
        if (!State.completedMissionIds.includes(m.id)) State.completedMissionIds.push(m.id);
        const repAdd = repFor(m.difficulty);
        State.reputation = Number(State.reputation || 0) + repAdd;
        const me = getActiveAddress() || 'anonymous';
        State.leaderboard[me] = Number(State.leaderboard[me] || 0) + repAdd;

        recalcTotals();
        updateUI();

        $('missionDetails').innerHTML = `
          <div>ID: <span class="mono">${m.id}</span></div>
          <div>Mission: ${m.title}</div>
          <div>Reward (simulated, local “credits”): <strong>${m.reward} FONE</strong></div>
          <div>Reputation: +${repAdd} pts</div>`;
        $('missionNotice').classList.remove('hidden');
        savePersistentForAddress(getActiveAddress());

        toast('Mission approved! (simulated reward)', 3000, 'success');
        showPage('dashboard');
      } catch (e) {
        toast('Error: ' + e.message, 3000, 'error');
      } finally {
        missionSubmitting = false;
      }
    });

    function randAddr() {
      const h = Array.from(crypto.getRandomValues(new Uint8Array(6))).map(b => b.toString(16).padStart(2, '0')).join('');
      return 'f' + h;
    }

    function buildReviewQueueAposta() {
      if (State.reviewQueue && State.reviewQueue.length) return;
      State.reviewQueue = [
        { id: 'R1', title: 'Community cleanup — Central square', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r1/640/360', report: 'Before and after are visible. Collected bags and identified team.', reward: 22, isValid: true },
        { id: 'R2', title: 'Electronic disposal — Official point', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r2/640/360', report: 'Photo of a generic box without proof of official drop-off.', reward: 25, isValid: false },
        { id: 'R3', title: 'Trees planted — Rua X', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r3/640/360', report: 'Seedlings with identification plate, date and location informed.', reward: 30, isValid: true },
        { id: 'R4', title: 'Recycling — Park', submitter: randAddr(), image: 'https://picsum.photos/seed/eco-r4/640/360', report: 'Blurred image and no clear separation of materials.', reward: 20, isValid: false }
      ];
    }

    function renderApostaPage() {
      const wrap = $('apostaList');
      if (!wrap) return;

      const demo = Number(State.demoBetBalance || 0);
      const creditsEl = $('apostaCredits');
      if (creditsEl) creditsEl.innerText = demo.toFixed(2);

      wrap.innerHTML = '';
      if (!State.reviewQueue.length) {
        wrap.innerHTML = '<div class="small-muted">— No cases to review —</div>';
        return;
      }

      State.reviewQueue.forEach(item => {
        const bet = State.bets[item.id];
        const statusLine = (() => {
          if (!bet) return '';
          if (bet.status === 'pending') {
            return `<div class="mt-2 text-xs small-muted"><span class="inline-flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse"></span>Waiting for majority…</span></div>`;
          }
          const maj = bet.majority === 'approve' ? 'APPROVED' : 'REJECTED';
          const res = bet.win ? 'You win 🎉' : 'You lose';
          const delta = bet.win
            ? `+${(bet.payout - bet.amount).toFixed(2)} demo FONE`
            : `-${bet.amount.toFixed(2)} demo FONE`;
          return `<div class="mt-2 text-xs"><div>Result: <strong>${maj}</strong></div><div>${res} • ${delta}</div></div>`;
        })();
        const disabled = bet && (bet.status === 'pending' || bet.status === 'settled') ? 'disabled' : '';

        const defaultBet = 10;

        const div = document.createElement('div');
        div.className = 'glass p-4 rounded';
        div.innerHTML = `
          <div class="font-semibold">${item.title}</div>
          <div class="text-xs small-muted">Reward (simulated): ${item.reward} FONE • Submitted by <span class="mono">${item.submitter}</span></div>
          <div class="mt-3"><img src="${item.image}" alt="proof" class="thumb" /></div>
          <div class="mt-2 small-muted">${item.report}</div>
          <div class="mt-3 text-xs small-muted">Bet up to 100 demo FONE (local simulated “credits”)</div>
          <div class="mt-1 flex items-center gap-2">
            <input id="bet-${item.id}" type="number" min="1" max="100" step="1"
              class="p-2 rounded app-input mono w-24 text-xs" ${disabled}
              value="${defaultBet}">
            <button class="btn-accent text-xs" ${disabled} onclick="placeBet('${item.id}','approve')">Validate</button>
            <button class="btn-muted text-xs" ${disabled} onclick="placeBet('${item.id}','reject')">Reject</button>
          </div>
          ${statusLine}`;
        wrap.appendChild(div);
      });

      try { lucide.createIcons(); } catch {}
    }

    window.placeBet = function placeBet(id, decision) {
      const item = State.reviewQueue.find(x => x.id === id);
      if (!item) return toast('Review item not found.', 2500, 'error');
      if (State.bets[id]) return toast('You already bet on this item.', 2500, 'info');

      const inp = $('bet-' + id);
      const amount = Number(inp?.value || 0);
      if (!Number.isFinite(amount) || amount <= 0) return toast('Enter a valid bet amount.', 2500, 'warning');
      if (amount > 100) return toast('Maximum bet is 100 demo FONE.', 3000, 'warning');

      const avail = Number(State.demoBetBalance || 0);
      if (amount > avail) return toast('Not enough demo balance to place this bet.', 3000, 'error');

      State.demoBetBalance = avail - amount;

      State.bets[id] = { amount, decision, status: 'pending', createdAt: Date.now() };
      savePersistentForAddress(getActiveAddress());
      renderApostaPage();
      toast('Bet placed (simulated). Waiting for majority…', 2800, 'info');
      setTimeout(() => settleBet(id), 3000);
    };

    function settleBet(id) {
      const item = State.reviewQueue.find(x => x.id === id);
      const bet = State.bets[id];
      if (!item || !bet || bet.status === 'settled') return;

      const majority = item.isValid ? 'approve' : 'reject';
      const userWin = (bet.decision === majority);
      const payout = userWin ? bet.amount * 1.75 : 0;

      if (payout > 0) {
        State.demoBetBalance = Number(State.demoBetBalance || 0) + payout;
      }

      bet.status = 'settled';
      bet.majority = majority;
      bet.payout = payout;
      bet.win = userWin;

      const votedStr = bet.decision === 'approve' ? 'APPROVE' : 'REJECT';
      const majStr = majority === 'approve' ? 'APPROVED' : 'REJECTED';
      const gain = userWin
        ? `Won +${(payout - bet.amount).toFixed(2)} demo FONE (received ${payout.toFixed(2)})`
        : `Lost ${bet.amount.toFixed(2)} demo FONE`;

      State.history.push(
        `[${new Date().toLocaleString()}] Bet (simulated): ${item.title} — vote ${votedStr}. ${gain} • majority: ${majStr}`
      );
      savePersistentForAddress(getActiveAddress());
      renderApostaPage();
      toast(
        userWin
          ? `You won the bet! (simulated) +${(payout - bet.amount).toFixed(2)} demo FONE`
          : `You lost the bet (simulated): -${bet.amount.toFixed(2)} demo FONE`,
        3800
      );
    }

    const LS_CONTACTS = 'ev_contacts';
    function getContacts() {
      try { return JSON.parse(localStorage.getItem(LS_CONTACTS) || '[]'); } catch { return []; }
    }
    function setContacts(list) {
      localStorage.setItem(LS_CONTACTS, JSON.stringify(list));
    }
    function renderContactsDatalist() {
      const data = getContacts();
      const dl = $('contactsData'); if (!dl) return;
      dl.innerHTML = '';
      data.forEach(c => {
        const o = document.createElement('option');
        o.value = c.address;
        o.label = c.label || c.address;
        dl.appendChild(o);
      });
    }
    function saveContact(address, label) {
      if (!address) return;
      const list = getContacts();
      if (!list.find(c => c.address === address)) {
        list.push({ address, label: label || '' });
        setContacts(list);
        renderContactsDatalist();
        toast('Contact saved.', 1400, 'success');
      } else {
        toast('Contact already exists.', 1600, 'info');
      }
    }

    let qrInstance = null;
    function openScan() {
      showModal('scanModal', true);
      const el = $('qr-reader');
      if (!el) return;
      if (qrInstance) return;
      try {
        qrInstance = new Html5Qrcode('qr-reader');
        qrInstance.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: 220 },
          (decodedText) => {
            $('inputDest').value = decodedText.trim();
            applySendValidationUI();
            closeScan();
            toast('Address filled from QR.', 1600, 'success');
          },
          () => {}
        ).catch(err => {
          toast('Error starting camera: ' + err, 3000, 'error');
        });
      } catch (e) {
        toast('QR scanner not available.', 2500, 'error');
      }
    }
    function closeScan() {
      if (qrInstance) {
        qrInstance.stop().then(() => {
          qrInstance.clear(); qrInstance = null;
        }).catch(()=>{});
      }
      showModal('scanModal', false);
    }

    function renderHistory() {
      const el = $('historyList');
      if (!el) return;
      el.innerHTML = '';
      if (!State.history?.length) {
        el.innerHTML = '<div class="small-muted">— No activity yet —</div>';
        return;
      }
      State.history.slice().reverse().forEach(line => {
        const d = document.createElement('div');
        d.className = 'p-3 glass rounded';
        d.innerText = line;
        el.appendChild(d);
      });
    }

    function renderLeaderboard() {
      const el = $('leaderboardList');
      if (!el) return;
      el.innerHTML = '';
      const arr = Object.keys(State.leaderboard).map(a => ({ addr: a, rep: Number(State.leaderboard[a] || 0) }));
      const me = getActiveAddress();
      if (me && !arr.find(x => x.addr === me)) arr.push({ addr: me, rep: State.reputation || 0 });
      arr.sort((a, b) => b.rep - a.rep);
      if (!arr.length) {
        el.innerHTML = '<div class="small-muted">— No players yet —</div>';
        return;
      }
      arr.forEach((u, idx) => {
        const isMe = me && me === u.addr;
        const row = document.createElement('div');
        row.className = 'p-3 glass rounded flex items-center gap-3';
        row.innerHTML = `<div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021124;font-size:.9rem;">${idx + 1}</div>
          <div style="flex:1">
            <div class="font-semibold text-sm">${isMe ? 'You' : (u.addr)}</div>
            <div class="text-[11px] small-muted">Reputation: <strong>${u.rep}</strong> pts</div>
          </div>
          <div class="text-xs small-muted">${u.rep} pts</div>`;
        el.appendChild(row);
      });
    }

    function renderReceivePage() {
      const addr = getActiveAddress() || '—';
      $('receiveAddr').innerText = addr;
      const qrEl = $('qrCode');
      if (qrEl) {
        qrEl.innerHTML = '';
        if (getActiveAddress()) new QRCode(qrEl, {
          text: addr,
          width: 196,
          height: 196,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }
    }

    function isPasswordSetApp() { return !!localStorage.getItem(PASS_VER); }

    function lockApp() { setUnlocked(false); }

    function showGate(show) {
      const el = $('gate');
      if (el) el.classList.toggle('show', !!show);
    }

    function bindGateUI() {
      const hasPwd = isPasswordSetApp();
      const createView = $('gateCreateView');
      const unlockView = $('gateUnlockView');
      if (createView) createView.classList.toggle('hidden', hasPwd);
      if (unlockView) unlockView.classList.toggle('hidden', !hasPwd);

      $('gateCreateBtn')?.addEventListener('click', async () => {
        const p1 = ($('newPass')?.value || '').trim();
        const p2 = ($('newPass2')?.value || '').trim();
        const msg = $('gateMsg');
        if (p1.length < 6) { msg.textContent = 'Use at least 6 characters.'; return; }
        if (p1 !== p2) { msg.textContent = 'Passwords do not match.'; return; }
        await setAppPassword(p1);
        setUnlocked(true);
        showGate(false);
        toast('Password created. App unlocked.', 1800);
      });

      $('gateBtn')?.addEventListener('click', async () => {
        const pass = ($('gatePass')?.value || '').trim();
        const msg = $('gateMsg2');
        if (!pass) { msg.textContent = 'Please enter your password.'; return; }
        if (await verifyAppPassword(pass)) {
          setUnlocked(true);
          showGate(false);
          toast('Unlocked 👌', 1500);
        } else {
          msg.textContent = 'Incorrect password.'; $('gatePass')?.select();
        }
      });

      $('gatePass')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') $('gateBtn')?.click();
      });
      $('newPass2')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') $('gateCreateBtn')?.click();
      });
    }

    function initPasswordLock() {
      if (!isPasswordSetApp()) {
        showGate(true);
        bindGateUI();
        return;
      }

      if (isUnlocked()) {
        showGate(false);
        return;
      }

      showGate(true);
      bindGateUI();
    }

    function requireActionPassword({ title = 'Confirm action', hint = 'Enter your password to continue.' } = {}) {
      return new Promise((resolve) => {
        $('authTitle').textContent = title;
        $('authHint').textContent = hint;
        $('authModal')?.classList.add('show');
        const onOk = async () => {
          const pass = ($('authPass')?.value || '').trim();
          if (!pass) { $('authMsg').textContent = 'Please enter your password.'; return; }
          if (await verifyAppPassword(pass)) {
            $('authModal')?.classList.remove('show');
            resolve(true);
          } else {
            $('authMsg').textContent = 'Incorrect password.'; $('authPass')?.select();
          }
        };
        const onCancel = () => { $('authModal')?.classList.remove('show'); resolve(false); };

        $('authOk').onclick = onOk;
        $('authCancel').onclick = onCancel;
        $('authPass').onkeydown = (e) => {
          if (e.key === 'Enter') onOk();
          if (e.key === 'Escape') onCancel();
        };
      });
    }

    function bindSaveCfgWatcher() {
      const btnTest = $('btnTestCfg');
      if (btnTest) {
        btnTest.addEventListener('click', async () => {
          $('cfgMsg').innerText = 'Demo mode: backend/API are not used.';
          toast('Demo mode: no backend calls are performed.', 2000, 'info');
        });
      }
    }

    document.querySelectorAll('.nav-link').forEach(a => a.addEventListener('click', () => {
      const r = a.dataset.route;
      showPage(r);
      if (window.innerWidth <= 900) {
        $('sidebar')?.classList.remove('open');
        $('sidebarBackdrop').style.display = 'none';
      }
    }));

    document.querySelectorAll('[data-route]')?.forEach(el => el.addEventListener('click', () => {
      const r = el.dataset.route;
      if (r) showPage(r);
    }));

    $('openWalletHistory')?.addEventListener('click', () => showPage('history'));
    $('mobileMenuBtn')?.addEventListener('click', () => {
      $('sidebar')?.classList.add('open');
      $('sidebarBackdrop').style.display = 'block';
    });
    $('sidebarBackdrop')?.addEventListener('click', () => {
      $('sidebar')?.classList.remove('open');
      $('sidebarBackdrop').style.display = 'none';
    });
    $('mobileLoginBtn')?.addEventListener('click', () => showModal('loginModal', true));
    $('openLoginBtn')?.addEventListener('click', () => showModal('loginModal', true));
    $('closeLogin')?.addEventListener('click', () => showModal('loginModal', false));

    $('themeToggle')?.addEventListener('click', () => {
      const cur = localStorage.getItem(LS_THEME) || 'dark';
      const next = cur === 'light' ? 'dark' : 'light';
      applyTheme(next);
      localStorage.setItem(LS_THEME, next);
      updateUI();
    });
    $('selTheme')?.addEventListener('change', (e) => {
      const v = e.target.value;
      applyTheme(v);
      localStorage.setItem(LS_THEME, v);
      updateUI();
    });

    $('btnCreateWallet')?.addEventListener('click', createWalletFlow);
    $('btnImportWallet')?.addEventListener('click', async () => {
      const pk = ($('inputPrivate')?.value || '').trim();
      await importWalletFlow(pk);
    });
    $('btnCopyPriv')?.addEventListener('click', () => {
      const txt = $('privText')?.innerText || '';
      navigator.clipboard.writeText(txt).then(() => toast('Private key copied.', 1800, 'success'));
    });
    $('btnPrivSaved')?.addEventListener('click', () => showModal('privModal', false));
    $('btnSyncAll')?.addEventListener('click', async () => {
      await syncAll();
      toast('Balance and history synced (demo).', 2000, 'success');
    });
    $('btnSyncBal')?.addEventListener('click', async () => {
      await syncAll();
      toast('Balance and history synced (demo).', 2000, 'success');
    });
    $('btnCopyAddr')?.addEventListener('click', () => {
      const addr = getActiveAddress();
      if (!addr) return toast('Wallet not connected.', 2000, 'warning');
      navigator.clipboard.writeText(addr).then(() => toast('Address copied.', 1800, 'success'));
    });
    $('btnShareAddr')?.addEventListener('click', async () => {
      const addr = getActiveAddress();
      if (!addr) return toast('Wallet not connected.', 2000, 'warning');
      if (navigator.share) {
        try {
          await navigator.share({ title: 'My FONE address (demo)', text: addr });
        } catch {}
      } else {
        navigator.clipboard.writeText(addr);
        toast('Address copied (share not supported).', 2200, 'info');
      }
    });
    $('btnDownloadQR')?.addEventListener('click', () => {
      const wrap = $('qrCode');
      if (!wrap) return;
      const img = wrap.querySelector('img');
      const canvas = wrap.querySelector('canvas');
      const dataUrl = img?.src || (canvas ? canvas.toDataURL('image/png') : null);
      if (!dataUrl) {
        toast('QR not available.', 2000, 'error');
        return;
      }
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = 'fone-address-qr.png';
      a.click();
    });

    document.addEventListener('input', (e) => {
      if (e.target && (e.target.id === 'inputDest' || e.target.id === 'inputAmt')) {
        applySendValidationUI();
      }
    });
    $('btnMax')?.addEventListener('click', () => {
      const onAvail = Number(State.balance?.onchain?.available || 0);
      $('inputAmt').value = onAvail.toFixed(2);
      applySendValidationUI();
    });

    $('btnSendTx')?.addEventListener('click', async () => {
      const v = validateSendForm();
      if (!v.ok) return applySendValidationUI();

      const msg = ($('inputMsg')?.value || '').trim();
      const sure = confirm(`Confirm sending (demo) ${v.amt} FONE to\n${v.dest}${msg ? `\n\nMessage: ${msg}` : ''}`);
      if (!sure) return;

      if (REQUIRE_PWD_FOR_SEND) {
        const ok = await requireActionPassword({
          title: 'Confirm send (demo)',
          hint: 'Enter your app password to authorize this demo transaction.'
        });
        if (!ok) return;
      }

      const addr = getActiveAddress();
      const pk = getPrivateKeySession(addr);
      if (!pk) {
        toast('Private key is not available in this session. Please import or create the wallet again in this browser.', 4500, 'error');
        return;
      }

      try {
        const r = await sendTransactionFlow(pk, v.dest, v.amt, msg);
        $('sendResult').innerText = JSON.stringify(r, null, 2);
        toast('Demo transaction recorded. Syncing...', 2500, 'success');
        setTimeout(syncAll, 300);
        showPage('history');
      } catch (err) {
        alert('Error sending (demo): ' + (err.message || err));
      }
    });

    $('logoutBtn')?.addEventListener('click', async () => {
      if (!confirm('Do you really want to logout?')) return;

      if (REQUIRE_PWD_FOR_LOGOUT) {
        const ok = await requireActionPassword({ title: 'Confirm logout', hint: 'Enter your app password to logout.' });
        if (!ok) return;
      }

      const oldAddr = getActiveAddress();
      if (oldAddr) clearPrivateKeySession(oldAddr);

      State.wallet = null;
      State.persistedWalletAddress = null;
      try { localStorage.removeItem(LS_LAST_WALLET); } catch {}

      State.balance = {
        onchain: { available: 0, staked: 0, vested: 0, total: 0 },
        totalUI: 0,
        disponivelUI: 0
      };
      State.history = [];
      State.reputation = 0;
      State.leaderboard = {};
      State.bets = {};
      State.missions = [];
      State.completedMissionIds = [];
      State.demoBetBalance = 1000;

      buildMissions();
      buildReviewQueueAposta();
      recalcTotals();
      updateUI();

      lockApp();
      showModal('loginModal', true);
      $('welcomeModal')?.classList.remove('show');
      toast('Logged out.', 2000, 'info');
    });

    $('btnStart')?.addEventListener('click', () => {
      $('welcomeModal')?.classList.remove('show');
      showModal('loginModal', true);
      localStorage.setItem(LS_WELCOME, '1');
    });

    (function init() {
      const lastAddr = State.persistedWalletAddress;
      if (lastAddr) {
        const persisted = loadPersistentForAddress(lastAddr);
        if (persisted) {
          State.balance = persisted.balance || State.balance;
          State.history = persisted.history || [];
          State.missions = persisted.missions || [];
          State.completedMissionIds = persisted.completedMissionIds || [];
          State.leaderboard = persisted.leaderboard || {};
          State.reputation = persisted.reputation || 0;
          State.reviewQueue = persisted.reviewQueue || [];
          State.bets = persisted.bets || {};
          State.demoBetBalance = typeof persisted.demoBetBalance === 'number' ? persisted.demoBetBalance : 1000;
        }
      }
      buildMissions();
      buildReviewQueueAposta();
      recalcTotals();
      const savedTheme = localStorage.getItem(LS_THEME) || 'dark';
      applyTheme(savedTheme);
      const sel = $('selTheme');
      if (sel) sel.value = savedTheme;

      if (State.persistedWalletAddress) {
        State.leaderboard[State.persistedWalletAddress] =
          Number(State.leaderboard[State.persistedWalletAddress] || State.reputation || 0);
      }
      updateUI();
      if (getActiveAddress()) {
        $('welcomeModal')?.classList.remove('show');
        $('loginModal')?.classList.remove('show');
        setTimeout(() => { try { syncAll(); } catch (e) {} }, 600);
      } else {
        $('welcomeModal')?.classList.remove('show');
        showModal('loginModal', true);
      }
      window.addEventListener('load', () => {
        initPasswordLock();
        bindSaveCfgWatcher();
        toast('Demo mode: no backend or node required. All actions are simulated locally.', 4800, 'info');
      });
      window.Eco = { State, syncAll, showPage };
    })();
  </script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</body>
</html>
